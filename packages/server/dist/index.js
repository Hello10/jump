function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=e(require("firebase-admin")),t=e(require("dataloader")),n=require("lodash"),o=require("apollo-server-cloud-functions"),i=require("firebase-functions"),c=require("graphql-tools");function u(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,r,t){return r&&u(e.prototype,r),t&&u(e,t),e}function s(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r}function l(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function d(e){var r=0;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,r){if(e){if("string"==typeof e)return l(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?l(e,void 0):void 0}}(e)))return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function f(e){if(!e)return e;switch(e.constructor.name){case"Array":return e.map(f);case"Object":return Object.keys(e).reduce(function(r,t){return r[t]=f(e[t]),r},{});case"Timestamp":return e.toDate();default:return e}}for(var h=function(e){function r(r){var t,n=r.code,o=void 0===n?"GraphQLError":n,i=r.message,c=void 0===i?"GraphQL error":i,u=r.params;return c.constructor===Function&&(c=c(u)),(t=e.call(this,c,o,u)||this).expected=!0,t}return s(r,e),r.prototype.is=function(e){return this.code===e},r}(o.ApolloError),v=function(e){function r(r){return e.call(this,{code:"DocumentDoesNotExist",message:"Document "+r.type+" with id "+r.id+" does not exist",params:r})||this}return s(r,e),r}(h),m=function(e){function r(r){return e.call(this,{code:"ResolverMissing",message:"Resolver missing: "+r.path,params:r})||this}return s(r,e),r}(h),p=function(e){function r(r){return e.call(this,{code:"ResolverAuthorizerMissing",message:"Resolver permission missing: "+r.path,params:r})||this}return s(r,e),r}(h),g=function(e){function r(r){return e.call(this,{code:"SessionUserNotFound",message:"Session user not found: "+r.id,params:r})||this}return s(r,e),r}(h),y=function(e){function r(r){return e.call(this,{code:"NotAuthorized",message:"Not authorized to access "+r.path,params:r})||this}return s(r,e),r}(h),b=function(e){function r(r){return e.call(this,{code:"AuthToken",message:"Auth token error "+r.code+": "+r.message,params:r})||this}return s(r,e),r}(h),w={__proto__:null,GraphQLError:h,DocumentDoesNotExistError:v,ResolverMissingError:m,ResolverAuthorizerMissingError:p,SessionUserNotFoundError:g,NotAuthorizedError:y,AuthTokenError:b},_=function(){function e(e){var r=e.getLoader;this.getCollection=e.getCollection,this.getLoader=r}e.get=function(e){return new this(e)};var o=e.prototype;return o.doc=function(e){return this.collection.doc(e)},o.add=function(e){var r=e.data;try{r=n.omit(r,"id");var t=this._timestampField();return r.created_at=t,r.updated_at=t,Promise.resolve(this.collection.add(r)).then(function(e){return r.id=e.id,r})}catch(e){return Promise.reject(e)}},o.set=function(e){var r=e.id,t=e.data,o=e.merge,i=void 0===o||o;try{var c=this;(t=n.omit(t,"id")).updated_at=c._timestampField();var u=c.doc(r);return Promise.resolve(u.set(t,{merge:i})).then(function(){return c.get({id:r})})}catch(e){return Promise.reject(e)}},o.addOrSetByField=function(e){var r=e.field,t=e.data,n=e.add,o=void 0===n?function(e){return e}:n;try{var i=this,c=t[r];return Promise.resolve(i.findOneByField(r)(c)).then(function(e){return e?i.set({id:e.id,data:t}):Promise.resolve(o(t)).then(function(e){return i.add({data:t=e})})})}catch(e){return Promise.reject(e)}},o.getOrAddById=function(e){var r=e.id,t=e.data,n=e.add,o=void 0===n?function(e){return e}:n;try{var i=this;return Promise.resolve(i.get({id:r})).then(function(e){var n=function(){if(!e)return Promise.resolve(o({id:r,data:t})).then(function(n){return t=n,Promise.resolve(i.set({id:r,data:t,merge:!1})).then(function(r){e=r})})}();return n&&n.then?n.then(function(){return e}):e})}catch(e){return Promise.reject(e)}},o.exists=function(e){try{var r=this.doc(e);return Promise.resolve(r.get()).then(function(e){return e.exists})}catch(e){return Promise.reject(e)}},o.get=function(e){var r=e.id,t=e.assert,n=void 0!==t&&t;try{var o=this,i=o.doc(r);return Promise.resolve(i.get()).then(function(e){if(n&&!e.exists)throw o._doesNotExistError(r);return o._snapToDoc(e)})}catch(e){return Promise.reject(e)}},o.getMany=function(e){var r=e.ids;try{var t=this;if(!r||0===r.length)return Promise.resolve([]);var o=n.uniq(r).map(function(e){return t.doc(e)});return Promise.resolve(t.db.getAll(o)).then(function(e){for(var n,o=e.map(function(e){return t._snapToDoc(e)}),i={},c=d(o);!(n=c()).done;){var u=n.value;u&&(i[u.id]=u)}return r.map(function(e){return e in i?i[e]:null})})}catch(e){return Promise.reject(e)}},o.find=function(e){var r=void 0===e?{}:e,t=r.where,o=r.limit,i=r.order_by,c=r.select;try{var u,a,s=this,l=function(e){throw new Error("Invalid "+e+" for find")},f=s.collection;if(t){var h;n.isObject(t)?h=Object.entries(t).map(function(e){return[e[0],"==",e[1]]}):Array.isArray(t)?h=Array.isArray(t[0])?t:[t]:l("where");for(var v,m=d(h);!(v=m()).done;){var p=v.value;3!==p.length&&l("where"),f=f.where(p[0],p[1],p[2])}}return i&&(Array.isArray(i)||(i=[i]),f=(u=f).orderBy.apply(u,i)),o&&(n.isNumber(o)||l("limit"),f=f.limit(o)),c&&(Array.isArray(c)||l("select"),f=(a=f).select.apply(a,c)),Promise.resolve(f.get()).then(function(e){return e.docs.map(s._snapToDoc)})}catch(e){return Promise.reject(e)}},o.findOne=function(e){var r=e.where,t=e.order_by,n=e.select;try{return Promise.resolve(this.find({limit:1,where:r,order_by:t,select:n})).then(function(e){return e.length>0?e[0]:null})}catch(e){return Promise.reject(e)}},o.findOneByField=function(e){var r=this;return function(t){return r.findOne({where:[e,"==",t]})}},o.delete=function(e){var r=e.id,t=e.ids,n=e.where;try{var o=function(){if(0===t.length)return Promise.resolve();for(var e,r=i.db.batch(),n=d(t);!(e=n()).done;){var o=i.doc(e.value);r.delete(o)}return r.commit()},i=this;if(r){var c=i.doc(r);return Promise.resolve(c.delete())}if(t&&n)throw new Error("Delete call should pass ids or where not both");var u=function(){if(n)return Promise.resolve(i.find({where:n})).then(function(e){t=e.map(function(e){return e.id})})}();return Promise.resolve(u&&u.then?u.then(o):o())}catch(e){return Promise.reject(e)}},o._timestampField=function(){return r.firestore.FieldValue.serverTimestamp()},o._deleteField=function(){return r.firestore.FieldValue.delete()},o._snapToDoc=function(e){if(e.exists){var r=e.data();return r.id=e.id,f(r)}return null},o._doesNotExistError=function(e){var r=this.name();return new v({type:r,id:e})},o._id=function(){return this.collection.doc().id},a(e,[{key:"name",get:function(){throw new Error("Collection child class must implement .name")}},{key:"db",get:function(){return r.firestore()}},{key:"collection",get:function(){return this.db.collection(this.name)}},{key:"loader",get:function(){var e=this;return new t(function(r){return e.getMany({ids:r})})}}]),e}(),P=function(){function e(){}return e.prototype.child=function(){return this},e}(),x=function(){var e=A[j];P.prototype[e]=function(){var r,t=global,n=t.console,o=e in n?n[e]:n.log;return(r=o).call.apply(r,[n].concat([].slice.call(arguments)))}},j=0,A=["trace","debug","info","warn","error","fatal"];j<A.length;j++)x();function E(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var S=function(){function e(e){var r=(void 0===e?{}:e).logger;r||(r=new P),this.logger=r}var r=e.prototype;return r.resolvers=function(){throw new Error("Child class must implement .resolvers")},r.collection=function(e){return e.context.getCollection(e.name||this.name)},r.loader=function(e){return e.context.getLoader(e.name||this.name)},r.expose=function(){for(var e=this,r={},t=this.logger,o=this.resolvers(),i=0,c=Object.entries(o);i<c.length;i++){var u=c[i],a=u[0],s=u[1];a in r||(r[a]={});for(var l=function(){var o=f[d],i=o[0],c=o[1],u=a+"."+i;if("__resolveType"===i)return r[a][i]=function(r,t,n){return c.call(e,{obj:r,context:t,info:n})},"continue";var s=c.resolver,l=c.authorizer;if(![s,l].every(n.isFunction))throw new Error("Invalid resolver definition for "+u);r[a][i]=function(r,n,o,i){try{return t.debug("Calling resolver "+u),Promise.resolve(E(function(){if(!s)throw new m({path:u});if(!l)throw new p({path:u});var t={obj:r,args:n,context:o,info:i},c=o.auth_error;if(c)throw c;return Promise.resolve(l.call(e,t)).then(function(r){if(!r)throw new y({path:u});return s.call(e,t)})},function(e){throw e.expected?(t.error(e,"Expected GraphQL error"),e):(t.error(e,"Unexpected GraphQL error"),new h)}))}catch(e){return Promise.reject(e)}}},d=0,f=Object.entries(s);d<f.length;d++)l()}return r},r.get=function(e){return this.collection(e).get(e.args)},r.list=function(e){return this.collection(e).list(e.args)},r.create=function(e){return this.collection(e).add(e.args.data)},r.update=function(e){var r=this.collection(e),t=e.args;return r.set({id:t.id,data:t.data})},r.delete=function(e){return this.collection(e).delete({id:e.args.id})},r.load=function(e){var r=e.collection,t=e.field;return function(e){var n=e.obj,o=e.context.getLoader(r),i=n[t];return i?o.load(i):null}},r.loadMany=function(e){var r=e.collection,t=e.field;return function(e){var n=e.obj,o=e.context.getLoader(r),i=n[t];return i.length?o.loadMany(i):[]}},r.resolveType=function(e){return function(r){var t=r.info,n=e(r.obj);return t.schema.getType(n)}},r.stub=function(){throw new Error("Unimplemented stub")},a(e,[{key:"name",get:function(){throw new Error("Child class must implement .name")}}]),e}();function C(e){var r=e.get("Authorization"),t=/^Bearer /;return r&&r.match(t)?r.replace(t,""):null}exports.Authorizers={__proto__:null,isSignedIn:function(e){return!!e.context.user_id},isPublic:function(){return!0}},exports.Collection=_,exports.Controller=S,exports.Errors=w,exports.getToken=C,exports.graphqlHandler=function(e){var t=e.Schema,u=e.Scalars,a=e.Controllers,s=e.context,l=e.getToken,d=e.user_collection,f=e.options,h=void 0===f?{}:f;s||(s=function(e){var t=e.Collections,n=e.getToken,o=e.user_collection;return function(e){var i=e.req;try{var c=function(){return{getCollection:a,getLoader:u,auth_error:f,token:h,user_id:l,user:d}},u=function(e){var r=e.name||e;if(!(r in s)){var t=a(r);s[r]=t.loader}return s[r]},a=function e(r){var n=r.name||r,o=t[n];if(!o)throw new Error("Collection with name "+n+" does not exist");return o.get({getCollection:e,getLoader:u})},s={},l=null,d=null,f=null,h=n(i),v=function(){if(h){var e=function(e,t){try{var n=(i=a(o),Promise.resolve(function(e){try{var t;return Promise.resolve(function(n,o){try{var i=(t=r.auth(),Promise.resolve(t.verifyIdToken(e)).then(function(e){return e.uid}))}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(e){throw new b({code:e.code,message:e.message})}))}catch(e){return Promise.reject(e)}}(h)).then(function(e){return l=e,Promise.resolve(i.get({id:l})).then(function(e){d=e})}))}catch(e){return t(e)}var i;return n&&n.then?n.then(void 0,t):n}(0,function(e){f=e});if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(v&&v.then?v.then(c):c())}catch(e){return Promise.reject(e)}}}({Collections:e.Collections,getToken:void 0===l?C:l,user_collection:void 0===d?"User":d}));var v=function(e){for(var r=e.Schema,t=e.Scalars,o={},i=0,u=Object.entries(e.Controllers);i<u.length;i++){var a=u[i],s=a[1];console.log("Exposing controller "+a[0]);var l=new s;n.merge(o,l.expose())}return n.merge(o,t),c.makeExecutableSchema({typeDefs:r,resolvers:o})}({Schema:t,Controllers:a,Scalars:u}),m=new o.ApolloServer({schema:v,context:s}).createHandler(h);return i.https.onRequest(m)},exports.initializeFirebase=function(e){var t=(0,e.getServiceAccount)(process.env.NODE_ENV),n=r.credential.cert(t);r.initializeApp({credential:n,databaseURL:"https://"+t.project_id+".firebaseio.com"})};
//# sourceMappingURL=index.js.map
