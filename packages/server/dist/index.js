parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"xIaj":[function(require,module,exports) {
"use strict";function e({context:e}){return!!e.user_id}function t(){return!0}Object.defineProperty(exports,"__esModule",{value:!0}),exports.isSignedIn=e,exports.isPublic=t;
},{}],"qQZz":[function(require,module,exports) {
"use strict";function e(t){switch(null==t?void 0:t.constructor.name){case"Array":return t.map(e);case"Object":return Object.keys(t).reduce((r,u)=>(r[u]=e(t[u]),r),{});case"Timestamp":return t.toDate();default:return t}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=e;
},{}],"vEB1":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthTokenError=exports.NotAuthorizedError=exports.SessionUserNotFoundError=exports.ResolverAuthorizerMissingError=exports.ResolverMissingError=exports.DocumentDoesNotExistError=exports.GraphQLError=void 0;var r=require("apollo-server-cloud-functions");class s extends r.ApolloError{constructor({code:r="GraphQLError",message:s="GraphQL error",params:e}){s.constructor===Function&&(s=s(e)),super(s,r,e),this.expected=!0}is(r){return this.code===r}}exports.GraphQLError=s;class e extends s{constructor(r){const{type:s,id:e}=r;super({code:"DocumentDoesNotExist",message:`Document ${s} with id ${e} does not exist`,params:r})}}exports.DocumentDoesNotExistError=e;class o extends s{constructor(r){super({code:"ResolverMissing",message:`Resolver missing: ${r.path}`,params:r})}}exports.ResolverMissingError=o;class t extends s{constructor(r){super({code:"ResolverAuthorizerMissing",message:`Resolver permission missing: ${r.path}`,params:r})}}exports.ResolverAuthorizerMissingError=t;class n extends s{constructor(r){super({code:"SessionUserNotFound",message:`Session user not found: ${r.id}`,params:r})}}exports.SessionUserNotFoundError=n;class c extends s{constructor(r){super({code:"NotAuthorized",message:`Not authorized to access ${r.path}`,params:r})}}exports.NotAuthorizedError=c;class i extends s{constructor(r){const{code:s,message:e}=r;super({code:"AuthToken",message:`Auth token error ${s}: ${e}`,params:r})}}exports.AuthTokenError=i;
},{}],"qt30":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var e=a(require("firebase-admin")),t=a(require("dataloader")),r=require("lodash"),i=a(require("./timestampsToDates")),s=require("./Errors");function a(e){return e&&e.__esModule?e:{default:e}}class d{static get(e){return new this(e)}constructor({getCollection:e,getLoader:t}){this.getCollection=e,this.getLoader=t}get name(){throw new Error("Collection child class must implement .name")}get db(){return e.default.firestore()}get collection(){return this.db.collection(this.name)}doc(e){return this.collection.doc(e)}get loader(){return new t.default(e=>this.getMany({ids:e}))}async add({data:e}){e=(0,r.omit)(e,"id");const t=this._timestampField();e.created_at=t,e.updated_at=t;const i=await this.collection.add(e);return e.id=i.id,e}async set({id:e,data:t,merge:i=!0}){(t=(0,r.omit)(t,"id")).updated_at=this._timestampField();const s=this.doc(e);return await s.set(t,{merge:i}),this.get({id:e})}async addOrSetByField({field:e,data:t,add:r=(e=>e)}){const i=t[e],s=await this.findOneByField(e)(i);if(s){const{id:e}=s;return this.set({id:e,data:t})}return t=await r(t),this.add({data:t})}async getOrAddById({id:e,data:t,add:r=(e=>e)}){let i=await this.get({id:e});return i||(t=await r({id:e,data:t}),i=await this.set({id:e,data:t,merge:!1})),i}async exists(e){const t=this.doc(e);return(await t.get()).exists}async get({id:e,assert:t=!1}){const r=this.doc(e),i=await r.get();if(t&&!i.exists){throw this._doesNotExistError(e)}return this._snapToDoc(i)}async getMany({ids:e}){if(!e||0===e.length)return[];const t=(0,r.uniq)(e).map(e=>this.doc(e)),i=(await this.db.getAll(t)).map(e=>this._snapToDoc(e)),s={};for(const r of i)r&&(s[r.id]=r);return e.map(e=>e in s?s[e]:null)}async find({where:e,limit:t,order_by:i,select:s}={}){let a=this.collection;function d(e){throw new Error(`Invalid ${e} for find`)}if(e){let t;(0,r.isObject)(e)?t=Object.entries(e).map(([e,t])=>[e,"==",t]):Array.isArray(e)?t=Array.isArray(e[0])?e:[e]:d("where");for(const e of t){3!==e.length&&d("where");const[t,r,i]=e;a=a.where(t,r,i)}}return i&&(Array.isArray(i)||(i=[i]),a=a.orderBy(...i)),t&&((0,r.isNumber)(t)||d("limit"),a=a.limit(t)),s&&(Array.isArray(s)||d("select"),a=a.select(...s)),(await a.get()).docs.map(this._snapToDoc)}async findOne({where:e,order_by:t,select:r}){const i=await this.find({limit:1,where:e,order_by:t,select:r});return i.length>0?i[0]:null}findOneByField(e){return t=>this.findOne({where:[e,"==",t]})}async delete({id:e,ids:t,where:r}){if(e){return this.doc(e).delete()}if(t&&r)throw new Error("Delete call should pass ids or where not both");if(r){t=(await this.find({where:r})).map(({id:e})=>e)}if(0===t.length)return Promise.resolve();const i=this.db.batch();for(const s of t){const e=this.doc(s);i.delete(e)}return i.commit()}_timestampField(){return e.default.firestore.FieldValue.serverTimestamp()}_deleteField(){return e.default.firestore.FieldValue.delete()}_snapToDoc(e){if(e.exists){const t=e.data();return t.id=e.id,(0,i.default)(t)}return null}_doesNotExistError(e){const t=this.name();return new s.DocumentDoesNotExistError({type:t,id:e})}_id(){return this.collection.doc().id}}exports.default=d;
},{"./timestampsToDates":"qQZz","./Errors":"vEB1"}],"p5bA":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;class e{child(){return this}}exports.default=e;const o=["trace","debug","info","warn","error","fatal"];for(const t of o)e.prototype[t]=function(...e){const{console:o}=global,r=t in o?o[t]:o.log;return r.call(o,...e)};
},{}],"Jfq0":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var e=require("lodash"),r=o(require("./Logger")),t=require("./Errors");function o(e){return e&&e.__esModule?e:{default:e}}const n="__resolveType";class s{constructor({logger:e}={}){e||(e=new r.default),this.logger=e}get name(){throw new Error("Child class must implement .name")}resolvers(){throw new Error("Child class must implement .resolvers")}collection({context:e,name:r}){return e.getCollection(r||this.name)}loader({context:e,name:r}){return e.getLoader(r||this.name)}expose(){const r={},{logger:o}=this,s=this.resolvers();for(const[i,l]of Object.entries(s)){i in r||(r[i]={});for(const[s,a]of Object.entries(l)){const l=`${i}.${s}`;if(s===n){r[i][s]=((e,r,t)=>a.call(this,{obj:e,context:r,info:t}));continue}const{resolver:c,authorizer:u}=a;if(![c,u].every(e.isFunction))throw new Error(`Invalid resolver definition for ${l}`);r[i][s]=(async(e,r,n,s)=>{o.debug(`Calling resolver ${l}`);try{if(!c)throw new t.ResolverMissingError({path:l});if(!u)throw new t.ResolverAuthorizerMissingError({path:l});const a={obj:e,args:r,context:n,info:s},{auth_error:d}=n;if(d)throw d;if(!(await u.call(this,a)))throw new t.NotAuthorizedError({path:l});return c.call(this,a)}catch(i){throw i.expected?(o.error(i,"Expected GraphQL error"),i):(o.error(i,"Unexpected GraphQL error"),new t.GraphQLError)}})}}return r}get(e){return this.collection(e).get(e.args)}list(e){return this.collection(e).list(e.args)}create(e){const r=this.collection(e),{data:t}=e.args;return r.add(t)}update(e){const r=this.collection(e),{id:t,data:o}=e.args;return r.set({id:t,data:o})}delete(e){const r=this.collection(e),{id:t}=e.args;return r.delete({id:t})}load({collection:e,field:r}){return({obj:t,context:o})=>{const n=o.getLoader(e),s=t[r];return s?n.load(s):null}}loadMany({collection:e,field:r}){return({obj:t,context:o})=>{const n=o.getLoader(e),s=t[r];return s.length?n.loadMany(s):[]}}resolveType(e){return({obj:r,info:t})=>{const o=e(r);return t.schema.getType(o)}}stub(){throw new Error("Unimplemented stub")}}exports.default=s;
},{"./Logger":"p5bA","./Errors":"vEB1"}],"NwZF":[function(require,module,exports) {
"use strict";function e(e){const t=e.get("Authorization"),r=/^Bearer /;return t&&t.match(r)?t.replace(r,""):null}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=e;
},{}],"QfwH":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=o;var e=require("graphql-tools"),r=require("lodash");function o({Schema:o,Controllers:s,Scalars:t}){const l={};for(const[e,c]of Object.entries(s)){console.log(`Exposing controller ${e}`);const o=new c;(0,r.merge)(l,o.expose())}return(0,r.merge)(l,t),(0,e.makeExecutableSchema)({typeDefs:o,resolvers:l})}
},{}],"CNFO":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=o;var e=t(require("firebase-admin")),r=require("./Errors");function t(e){return e&&e.__esModule?e:{default:e}}async function o(t){try{const u=e.default.auth();return(await u.verifyIdToken(t)).uid}catch(o){const{code:e,message:t}=o;throw new r.AuthTokenError({code:e,message:t})}}
},{"./Errors":"vEB1"}],"fE9V":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=n;var e=t(require("./getUserIdFromToken"));function t(e){return e&&e.__esModule?e:{default:e}}function n({Collections:t,getToken:n,user_collection:o}){return async({req:r})=>{const l={};function u(e){const t=e.name||e;if(!(t in l)){const e=i(t);l[t]=e.loader}return l[t]}function i(e){const n=e.name||e,o=t[n];if(!o)throw new Error(`Collection with name ${n} does not exist`);return o.get({getCollection:i,getLoader:u})}let c=null,s=null,a=null;const d=n(r);if(d)try{const t=i(o);c=await(0,e.default)(d),s=await t.get({id:c})}catch(f){a=f}return{getCollection:i,getLoader:u,auth_error:a,token:d,user_id:c,user:s}}}
},{"./getUserIdFromToken":"CNFO"}],"Ivfd":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=a;var e=c(require("firebase-functions")),t=require("apollo-server-cloud-functions"),r=u(require("./makeSchema")),o=u(require("./contextBuilder")),n=u(require("./getToken"));function u(e){return e&&e.__esModule?e:{default:e}}function l(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return l=function(){return e},e}function c(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=l();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var u=o?Object.getOwnPropertyDescriptor(e,n):null;u&&(u.get||u.set)?Object.defineProperty(r,n,u):r[n]=e[n]}return r.default=e,t&&t.set(e,r),r}function a({Schema:u,Scalars:l,Controllers:c,Collections:a,context:i,getToken:s=n.default,user_collection:f="User",options:p={}}){i||(i=(0,o.default)({Collections:a,getToken:s,user_collection:f}));const d=(0,r.default)({Schema:u,Controllers:c,Scalars:l}),y=new t.ApolloServer({schema:d,context:i}).createHandler(p);return e.https.onRequest(y)}
},{"./makeSchema":"QfwH","./contextBuilder":"fE9V","./getToken":"NwZF"}],"KKdY":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=r;var e=t(require("firebase-admin"));function t(e){return e&&e.__esModule?e:{default:e}}function r({getServiceAccount:t}){const r=t(process.env.NODE_ENV),i=e.default.credential.cert(r),{project_id:a}=r,c=`https://${a}.firebaseio.com`;e.default.initializeApp({credential:i,databaseURL:c})}
},{}],"Focm":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"Collection",{enumerable:!0,get:function(){return r.default}}),Object.defineProperty(exports,"Controller",{enumerable:!0,get:function(){return t.default}}),Object.defineProperty(exports,"getToken",{enumerable:!0,get:function(){return o.default}}),Object.defineProperty(exports,"graphqlHandler",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(exports,"initializeFirebase",{enumerable:!0,get:function(){return i.default}}),exports.Errors=exports.Authorizers=void 0;var e=f(require("./Authorizers"));exports.Authorizers=e;var r=l(require("./Collection")),t=l(require("./Controller")),n=f(require("./Errors"));exports.Errors=n;var o=l(require("./getToken")),u=l(require("./graphqlHandler")),i=l(require("./initializeFirebase"));function l(e){return e&&e.__esModule?e:{default:e}}function a(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return a=function(){return e},e}function f(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=a();if(r&&r.has(e))return r.get(e);var t={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var u=n?Object.getOwnPropertyDescriptor(e,o):null;u&&(u.get||u.set)?Object.defineProperty(t,o,u):t[o]=e[o]}return t.default=e,r&&r.set(e,t),t}
},{"./Authorizers":"xIaj","./Collection":"qt30","./Controller":"Jfq0","./Errors":"vEB1","./getToken":"NwZF","./graphqlHandler":"Ivfd","./initializeFirebase":"KKdY"}]},{},["Focm"], null)
//# sourceMappingURL=/index.js.map