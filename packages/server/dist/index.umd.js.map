{"version":3,"file":"index.umd.js","sources":["../src/Authorizers.js","../src/Collection.js","../src/Errors.js","../src/Controller.js","../src/timestampsToDates.js","../src/FirestoreCollection.js","../src/debug.js","../src/makeSchema.js","../src/contextBuilder.js","../src/graphqlHandler.js"],"sourcesContent":["export function isExisting ({context}) {\n  return !!context.user;\n}\n\nexport function isSignedIn ({context}) {\n  return !!context.user_id;\n}\n\nexport function isPublic () {\n  return true;\n}\n","import DataLoader from 'dataloader';\n\nexport default class Collection {\n  static get (args) {\n    return new this(args);\n  }\n\n  get name () {\n    throw new Error('Collection child class must implement .name');\n  }\n\n  get collection () {\n    throw new Error('Collection child class must implement .collection');\n  }\n\n  get loader () {\n    return new DataLoader((ids)=> {\n      return this.getMany({ids});\n    });\n  }\n\n  //////////\n  // CRUD //\n  //////////\n\n  // TODO: generalize the safe thing derp\n\n\n  create (/* {data} */) {\n    throw new Error('Collection child class must implement .create');\n  }\n\n  exists (/* {id} */) {\n    throw new Error('Collection child class must implement .exists');\n  }\n\n  get (/* {id, safe = false} */) {\n    throw new Error('Collection child class must implement .get');\n  }\n\n  getSafe ({id}) {\n    return this.get({id, safe: true});\n  }\n\n  getMany (/* {ids, safe = false} */) {\n    throw new Error('Collection child class must implement .getMany');\n  }\n\n  getManySafe ({ids}) {\n    return this.getMany({ids, safe: true});\n  }\n\n  find () {\n    // TODO:\n  }\n\n  set (/* {id, data, safe = false} */) {\n    throw new Error('Collection child class must implement .set');\n  }\n\n  setSafe ({id, data}) {\n    return this.setMany({id, data, safe: true});\n  }\n\n  merge (/* {id, data, safe = false} */) {\n    throw new Error('Collection child class must implement .merge');\n  }\n\n  mergeSafe ({id, data}) {\n    return this.merge({id, data, safe: true});\n  }\n\n  delete (/* {id, safe = false} */) {\n    throw new Error('Collection child class must implement .delete');\n  }\n\n  deleteSafe ({id}) {\n    return this.delete({id, safe: true});\n  }\n}\n","import {ApolloError} from 'apollo-server-cloud-functions';\n\nexport class GraphQLError extends ApolloError {\n  constructor ({\n    code = 'GraphQLError',\n    message = 'GraphQL error',\n    params\n  }) {\n    if (message.constructor === Function) {\n      message = message(params);\n    }\n    super(message, code, params);\n    this.expected = true;\n  }\n\n  is (code) {\n    return (this.code === code);\n  }\n}\n\nexport class DocumentDoesNotExistError extends GraphQLError {\n  constructor (params) {\n    const {type, id} = params;\n    super({\n      code: 'DocumentDoesNotExist',\n      message: `Document ${type} with id ${id} does not exist`,\n      params\n    });\n  }\n}\n\nexport class SessionUserNotFoundError extends GraphQLError {\n  constructor (params) {\n    super({\n      code: 'SessionUserNotFound',\n      message: `Session user not found: ${params.id}`,\n      params\n    });\n  }\n}\n\nexport class NotAuthorizedError extends GraphQLError {\n  constructor (params) {\n    super({\n      code: 'NotAuthorized',\n      message: `Not authorized to access ${params.path}`,\n      params\n    });\n  }\n}\n","import {isFunction} from 'lodash';\nimport Logger from '@hello10/logger';\n\nimport {\n  GraphQLError,\n  NotAuthorizedError\n} from './Errors';\n\n// to: helpers\nfunction capitalize (str) {\n  return str[0].toUpperCase() + str.slice(1);\n}\n\nconst APOLLO_UNION_RESOLVER_NAME = '__resolveType';\n\nexport default class Controller {\n  constructor (options) {\n    this.options = options;\n    let {logger} = options;\n    if (!logger) {\n      logger = new Logger('jump:controller');\n    }\n    this.logger = logger;\n  }\n\n  get name () {\n    throw new Error('Child class must implement .name');\n  }\n\n  static resolvers () {\n    // Child class should implement this method and return\n    // an object with this shape:\n    //\n    // {\n    //   // Mutations resolved in this controller\n    //   Mutation: {\n    //     <MutationName>: {\n    //       resolver: Function,\n    //       authorizer: Function\n    //     }\n    //   },\n    //   // Queries resolved in this controller\n    //   Query: {\n    //     <QueryName>: {\n    //       resolver: Function,\n    //       authorizer: Function\n    //     }\n    //   },\n    //   // Type fields resolved in this controller\n    //   <TypeName>: {\n    //     <FieldName>: {\n    //       resolver: Function,\n    //       authorizer: Function\n    //     }\n    //   },\n    //   <UnionTypeName>: {\n    //     __resolveType: Function\n    //   }\n    // }\n    throw new Error('Child class must implement .resolvers');\n  }\n\n  collection ({context, name}) {\n    return context.getCollection(name || this.name);\n  }\n\n  loader ({context, name}) {\n    return context.getLoader(name || this.name);\n  }\n\n  expose () {\n    const {logger} = this;\n\n    const result = {};\n\n    const groups = this.resolvers();\n    for (const [type, group] of Object.entries(groups)) {\n      if (!(type in result)) {\n        result[type] = {};\n      }\n\n      for (const [name, definition] of Object.entries(group)) {\n        const path = `${type}.${name}`;\n\n        // Resolve Union types\n        // https://www.apollographql.com/docs/graphql-tools/resolvers/#unions-and-interfaces\n        if (name === APOLLO_UNION_RESOLVER_NAME) {\n          result[type][name] = (obj, context, info)=> {\n            return definition.call(this, {obj, context, info});\n          };\n          continue;\n        }\n\n        // This seems like a dumb idea unless there's some dynmamic thing that\n        // is difficult to do without this..\n        // let the resolvers and permission be specified as strings\n        // for (const [k, v] of Object.entries(config)) {\n        //   if (Type(v, String)) {\n        //     config[k] = this[v];\n        //   }\n        // }\n\n        for (const field of ['authorizer', 'resolver']) {\n          if (!isFunction(definition[field])) {\n            throw new Error(`Invalid ${field} definition for ${path}`);\n          }\n        }\n\n        const {resolver, authorizer} = definition;\n        result[type][name] = async (obj, args, context, info)=> {\n          logger.debug(`Calling resolver ${path}`);\n\n          try {\n            const {user} = context;\n            const params = {obj, args, context, info, user};\n\n            // Have to handle this explicitly, would be better to have\n            // this in context build derp meh\n            const {load_user_error} = context;\n            if (load_user_error) {\n              throw load_user_error;\n            }\n\n            const res_logger = logger.child({\n              resolver: name,\n              type,\n              user\n            });\n\n            const authorized = await authorizer.call(this, params);\n            if (!authorized) {\n              const error = new NotAuthorizedError({path});\n              res_logger.error(error);\n              throw error;\n            }\n\n            res_logger.info('Calling resolver', {obj, args});\n            return resolver.call(this, params);\n          } catch (error) {\n            if (error.expected) {\n              logger.error('Expected GraphQL error', error);\n              throw error;\n            } else {\n              logger.error('Unexpected GraphQL error', error);\n              throw new GraphQLError();\n            }\n          }\n        };\n      }\n    }\n    return result;\n  }\n\n\n  ///////////////////////\n  // Generic Resolvers //\n  ///////////////////////\n  // Delegate all the reads derp\n  // TODO: move to loop at end adding to proto\n  exists = this._toCollection('exists');\n  get = this._toCollection('get');\n  list = this._toCollection('list');\n  create = this._wrapToCollection('create')\n  set = this._wrapToCollection('set');\n\n  async delete (request) {\n    if (this.beforeDelete) {\n      await this.beforeDelete(request);\n    }\n\n    const {id} = request.args;\n    const deleted = await this.delete({id});\n    const deleted_at = new Date();\n\n    if (this.afterDelete) {\n      await this.afterDelete({...request, deleted, deleted_at});\n    }\n\n    return {deleted_at, deleted};\n  }\n\n  _toCollection (method) {\n    return (request)=> {\n      const collection = this.collection(request);\n      return collection[method](request.args);\n    };\n  }\n\n  _wrapToCollection (method) {\n    const cmethod = capitalize(method);\n    const before = `before${cmethod}`;\n    const after = `after${cmethod}`;\n\n    return async (request)=> {\n      const collection = this.collection(request);\n\n      let {data} = request.args;\n      if (this[before]) {\n        data = await this[before](request);\n      }\n\n      let doc = await collection[method]({data});\n      if (this[after]) {\n        doc = await this[after]({...request, data, doc});\n      }\n\n      return doc;\n    };\n  }\n\n  load ({collection, field}) {\n    return ({obj, context})=> {\n      const loader = context.getLoader(collection);\n      const id = obj[field];\n      return id ? loader.load(id) : null;\n    };\n  }\n\n  loadMany ({collection, field}) {\n    return ({obj, context})=> {\n      const loader = context.getLoader(collection);\n      const ids = obj[field];\n      return ids.length ? loader.loadMany(ids) : [];\n    };\n  }\n\n  resolveType (getType) {\n    return ({obj, info})=> {\n      const type = getType(obj);\n      return info.schema.getType(type);\n    };\n  }\n\n  stub () {\n    throw new Error('Unimplemented stub');\n  }\n}\n","export default function timestampsToDates (obj) {\n  if (!obj) {\n    return obj;\n  }\n  const type = obj.constructor.name;\n  switch (type) {\n    case 'Array':\n      return obj.map(timestampsToDates);\n    case 'Object':\n      return Object.keys(obj).reduce((result, k)=> {\n        result[k] = timestampsToDates(obj[k]);\n        return result;\n      }, {});\n    case 'Timestamp':\n      return obj.toDate();\n    default:\n      return obj;\n  }\n}\n","import {omit, uniq, isNumber, isObject} from 'lodash';\n\nimport Collection from './Collection';\nimport timestampsToDates from './timestampsToDates';\nimport {DocumentDoesNotExistError} from './Errors';\n\nexport default class FirestoreCollection extends Collection {\n  constructor ({Admin, app, getCollection, getLoader}) {\n    super();\n    this.Admin = Admin;\n    this.app = app;\n    this.getCollection = getCollection;\n    this.getLoader = getLoader;\n  }\n\n  get auth () {\n    return this.app.auth();\n  }\n\n  get collection () {\n    return this.app.firestore().collection(this.name);\n  }\n\n  doc (id) {\n    return this.collection.doc(id);\n  }\n\n  //////////\n  // CRUD //\n  //////////\n  async add ({data}) {\n    data = omit(data, 'id');\n    const timestamp = this._timestampField();\n    data.created_at = timestamp;\n    data.updated_at = timestamp;\n    const ref = await this.collection.add(data);\n    data.id = ref.id;\n    return data;\n  }\n\n  async set ({id, data, merge = true}) {\n    data = omit(data, 'id');\n    data.updated_at = this._timestampField();\n    const ref = this.doc(id);\n    await ref.set(data, {merge});\n    return this.get({id});\n  }\n\n  async addOrSetByField ({field, data, add = (x)=> x}) {\n    const value = data[field];\n    const doc = await this.findOneByField(field)(value);\n    if (doc) {\n      const {id} = doc;\n      return this.set({id, data});\n    } else {\n      data = await add(data);\n      return this.add({data});\n    }\n  }\n\n  async getOrAddById ({id, data, add = (x)=> x}) {\n    let user = await this.get({id});\n    if (!user) {\n      data = await add(data);\n      user = await this.set({id, data, merge: false});\n    }\n    return user;\n  }\n\n  async exists ({id}) {\n    const ref = this.doc(id);\n    const snap = await ref.get();\n    return snap.exists;\n  }\n\n  async get ({id, safe = false}) {\n    const ref = this.doc(id);\n    const snap = await ref.get();\n    if (safe && !snap.exists) {\n      const type = this.name();\n      throw new DocumentDoesNotExistError({type, id});\n    }\n    return this._snapToDoc(snap);\n  }\n\n  async getAssert ({id}) {\n    return this.get({id, safe: true});\n  }\n\n  async getMany ({ids}) {\n    if (!ids || ids.length === 0) {\n      return [];\n    }\n\n    const uniques = uniq(ids);\n    const refs = uniques.map((id)=> this.doc(id));\n    const snaps = await this.firestore.getAll(refs);\n    const docs = snaps.map((snap)=> this._snapToDoc(snap));\n\n    const docs_by_id = {};\n    for (const doc of docs) {\n      if (doc) {\n        docs_by_id[doc.id] = doc;\n      }\n    }\n\n    return ids.map((id)=> {\n      return (id in docs_by_id) ? docs_by_id[id] : null;\n    });\n  }\n\n  async find ({where, limit, order_by, select} = {}) {\n    let query = this.collection;\n\n    function invalid (field) {\n      throw new Error(`Invalid ${field} for find`);\n    }\n\n    if (where) {\n      let parts;\n      if (isObject(where)) {\n        parts = Object.entries(where).map(([field, value])=> {\n          return [field, '==', value];\n        });\n      } else if (Array.isArray(where)) {\n        parts = Array.isArray(where[0]) ? where : [where];\n      } else {\n        invalid('where');\n      }\n\n      for (const part of parts) {\n        if (part.length !== 3) {\n          invalid('where');\n        }\n        const [field, op, value] = part;\n        query = query.where(field, op, value);\n      }\n    }\n\n    if (order_by) {\n      if (!Array.isArray(order_by)) {\n        order_by = [order_by];\n      }\n      query = query.orderBy(...order_by);\n    }\n\n\n    if (limit) {\n      if (!isNumber(limit)) {\n        invalid('limit');\n      }\n      query = query.limit(limit);\n    }\n\n    if (select) {\n      if (!Array.isArray(select)) {\n        invalid('select');\n      }\n      query = query.select(...select);\n    }\n\n    const snap = await query.get();\n    return snap.docs.map(this._snapToDoc);\n  }\n\n  async findOne ({where, order_by, select}) {\n    const docs = await this.find({\n      limit: 1,\n      where,\n      order_by,\n      select\n    });\n    return (docs.length > 0) ? docs[0] : null;\n  }\n\n  findOneByField (field) {\n    return (value)=> {\n      return this.findOne({\n        where: [field, '==', value]\n      });\n    };\n  }\n\n  async delete ({id, ids, where}) {\n    if (id) {\n      const ref = this.doc(id);\n      return ref.delete();\n    }\n\n    if (ids && where) {\n      throw new Error('Delete call should pass ids or where not both');\n    }\n\n    if (where) {\n      const docs = await this.find({where});\n      ids = docs.map(({id})=> id);\n    }\n\n    if (ids.length === 0) {\n      return Promise.resolve();\n    }\n\n    const batch = this.firestore.batch();\n    for (const id of ids) {\n      const ref = this.doc(id);\n      batch.delete(ref);\n    }\n    return batch.commit();\n  }\n\n  /////////////\n  // Helpers //\n  /////////////\n\n  _timestampField () {\n    return this.Admin.firestore.FieldValue.serverTimestamp();\n  }\n\n  _deleteField () {\n    return this.Admin.firestore.FieldValue.delete();\n  }\n\n  _snapToDoc (snap) {\n    if (snap.exists) {\n      const data = snap.data();\n      data.id = snap.id;\n      return timestampsToDates(data);\n    } else {\n      return null;\n    }\n  }\n\n  _id () {\n    const ref = this.collection.doc();\n    return ref.id;\n  }\n}\n","import makeDebug from 'debug';\n\nconst debug = makeDebug('jump');\n\nexport default debug;\n","import {makeExecutableSchema} from 'graphql-tools';\nimport {merge} from 'lodash';\n\nimport debug from './debug';\n\nexport default function makeSchema ({Schema, Controllers, Scalars, options}) {\n  const resolvers = {};\n  for (const [name, Controller] of Object.entries(Controllers)) {\n    debug(`Exposing controller ${name}`);\n    const controller = new Controller(options);\n    // TODO: shouldn't need to instantiate each controller per request,\n    // just figure out the dispatch and then instantiate on demand unless\n    // there's some memoization that can be done between requests.\n    // Super Bonus (whole why): context becomes part of this instead of a var\n    merge(resolvers, controller.expose());\n  }\n  merge(resolvers, Scalars);\n\n  return makeExecutableSchema({\n    typeDefs: Schema,\n    resolvers\n  });\n}\n","export default function contextBuilder ({\n  Collections,\n  getToken,\n  loadUserFromToken,\n  options\n}) {\n  return async ({req})=> {\n    const loaders = {};\n    function getLoader (arg) {\n      const name = arg.name || arg;\n      if (!(name in loaders)) {\n        const collection = getCollection(name);\n        loaders[name] = collection.loader;\n      }\n      return loaders[name];\n    }\n\n    function getCollection (arg) {\n      const name = arg.name || arg;\n      const Collection = Collections[name];\n      if (!Collection) {\n        throw new Error(`Collection with name ${name} does not exist`);\n      }\n\n      return Collection.get({\n        getCollection,\n        getLoader,\n        ...options\n      });\n    }\n\n    let user_id = null;\n    let user = null;\n    let load_user_error = null;\n\n    const token = getToken(req);\n    if (token) {\n      try {\n        ({user_id, user} = await loadUserFromToken({token, getCollection}));\n      } catch (error) {\n        console.error(error);\n        load_user_error = error;\n      }\n    }\n\n    return {\n      getCollection,\n      getLoader,\n      token,\n      user_id,\n      user,\n      load_user_error,\n      ...options\n    };\n  };\n}\n","import {ApolloServer} from 'apollo-server-cloud-functions';\n\nimport makeSchema from './makeSchema';\nimport contextBuilder from './contextBuilder';\n\nfunction getTokenDefault (request) {\n  const header = request.get('Authorization');\n  const prefix = /^Bearer /;\n  if (header && header.match(prefix)) {\n    return header.replace(prefix, '');\n  } else {\n    return null;\n  }\n}\n\nexport default function graphqlHandler ({\n  Collections,\n  Controllers,\n  Scalars,\n  Schema,\n  getToken = getTokenDefault,\n  loadUserFromToken,\n  options = {}\n}) {\n  const {\n    server: opts_server = {},\n    handler: opts_handler = {},\n    context: opts_context = {}\n  } = options;\n\n  if (!opts_server.context) {\n    opts_server.context = contextBuilder({\n      options: opts_context,\n      Collections,\n      getToken,\n      loadUserFromToken\n    });\n  }\n\n  const schema = makeSchema({\n    options: opts_context,\n    Schema,\n    Controllers,\n    Scalars\n  });\n\n  const server = new ApolloServer({...opts_server, schema});\n  return server.createHandler(opts_handler);\n}\n"],"names":["isExisting","context","user","isSignedIn","user_id","isPublic","Collection","get","args","name","Error","collection","loader","DataLoader","ids","getMany","create","exists","getSafe","id","safe","getManySafe","find","set","setSafe","data","setMany","merge","mergeSafe","delete","deleteSafe","GraphQLError","ApolloError","constructor","code","message","params","Function","expected","is","DocumentDoesNotExistError","type","NotAuthorizedError","path","body","recover","result","e","then","capitalize","str","toUpperCase","slice","APOLLO_UNION_RESOLVER_NAME","Controller","options","_toCollection","list","_wrapToCollection","logger","Logger","resolvers","getCollection","getLoader","expose","groups","group","Object","entries","definition","obj","info","call","field","isFunction","resolver","authorizer","debug","load_user_error","res_logger","child","authorized","error","request","deleted","deleted_at","Date","afterDelete","beforeDelete","method","cmethod","before","after","doc","load","loadMany","length","resolveType","getType","schema","stub","timestampsToDates","map","keys","reduce","k","toDate","FirestoreCollection","Admin","app","auth","firestore","add","omit","timestamp","_timestampField","created_at","updated_at","ref","addOrSetByField","x","value","findOneByField","getOrAddById","snap","_snapToDoc","getAssert","uniques","uniq","refs","getAll","snaps","docs","docs_by_id","where","limit","order_by","select","invalid","query","parts","isObject","Array","isArray","part","op","orderBy","isNumber","findOne","Promise","resolve","batch","commit","FieldValue","serverTimestamp","_deleteField","_id","makeDebug","makeSchema","Schema","Controllers","Scalars","controller","makeExecutableSchema","typeDefs","contextBuilder","Collections","getToken","loadUserFromToken","req","token","arg","loaders","console","getTokenDefault","header","prefix","match","replace","graphqlHandler","server","opts_server","handler","opts_handler","opts_context","ApolloServer","createHandler"],"mappings":"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"}