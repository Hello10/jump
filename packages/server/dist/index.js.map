{"version":3,"file":"index.js","sources":["../src/logger.js","../src/initialize.js","../src/collections/Collection.js","../src/collections/timestampsToDates.js","../src/Errors.js","../src/collections/FirestoreCollection.js","../src/handlers/graphql/Authorizers.js","../src/handlers/processOptions.js","../src/handlers/graphql/getToken.js","../src/handlers/graphql/contextBuilder.js","../src/handlers/graphql/formatError.js","../src/handlers/graphql/exposeResolvers.js","../src/handlers/graphql/createGraphqlHandler.js","../src/handlers/graphql/GraphQLController.js","../src/handlers/graphql/processSchema.js","../src/handlers/http/createHttpHandler.js","../src/handlers/Handler.js","../src/handlers/http/HttpHandler.js","../src/handlers/pubsub/createPubSubHandler.js","../src/handlers/pubsub/PubSubHandler.js","../src/directGraphqlRequest.js"],"sourcesContent":["import Logger from '@hello10/logger';\n\nconst logger = new Logger('jump');\n\nexport default logger;\n","import default_logger from './logger';\n\nexport default function initialize (options) {\n  const {namespace} = options;\n  const required = [\n    'Admin',\n    'app',\n    'Enums',\n    'getCollection',\n    'getService'\n  ];\n  for (const name of required) {\n    if (!options[name]) {\n      throw new Error(`Missing required argument for ${namespace}: ${name}`);\n    }\n    this[name] = options[name];\n  }\n\n  let {logger} = options;\n  if (!logger) {\n    logger = default_logger;\n  }\n  this.logger = logger.child(`${namespace}:${this.name}`);\n}\n","import DataLoader from 'dataloader';\nimport {compact} from 'lodash';\nimport Promise from 'bluebird';\nimport {singleton} from '@hello10/util';\n\nimport initialize from '../initialize';\n\nexport default class Collection {\n  constructor (options) {\n    initialize.call(this, {namespace: 'Collection', ...options});\n  }\n\n  bucket (name) {\n    return this.Admin.storage().bucket(name);\n  }\n\n  // Leaf child classes MUST overide name getter that the name of the\n  // collection backing this collection\n  // ================================================================\n  get name () {\n    throw new Error('Collection child class must implement .name');\n  }\n\n  // Implementation child classes MUST overide collection getter that\n  // returns a collection instance from the backing database\n  // ================================================================\n  get collection () {\n    throw new Error('Collection child class must implement .collection');\n  }\n\n  // Implementation child classes MUST override unimplemented methods\n  // ================================================================\n  // create    ({data})\n  // exists    ({id, assert = false})\n  // get       ({id, assert = false})\n  // getAll    ({ids, assert = false})\n  // find      ({query, limit, sort, start_at, start_after, select} = {})\n  // update    ({id, data, merge = true, assert = false})\n  // delete    ({id, assert = true})\n  // deleteAll ({ids})\n  //\n  // Child classes MAY override implemented CRUD methods\n  // ================================================================\n  // createAll       ({datas})\n  // findOrCreate    ({query, data})\n  // existsAssert    ({id})\n  // existsAll       ({ids, assert = false})\n  // existsAllAssert ({ids})\n  // getAssert       ({id})\n  // getAllAssert    ({ids})\n  // findOne         ({query, sort, select})\n  // findIds         ({query})\n  // list            ({limit, sort, start_at, start_after} = {})\n  // updateAssert    ({id, data, merge = true})\n  // updateAll       ({ids, data, merge = true, assert = false})\n  // updateAllAssert ({ids, data, merge = true})\n  // updateMany      ({query, data, merge = true})\n  // deleteAssert    ({id})\n  // deleteMany      ({query})\n\n  /////////////////\n  // Core:Create //\n  /////////////////\n\n  create (/* {data} */) {\n    throw new Error('Collection child class must implement .create');\n  }\n\n  createAll ({datas}) {\n    return Promise.map(datas, (data)=> this.create({data}));\n  }\n\n  async findOrCreate ({query, data}) {\n    const doc = await this.findOne({query});\n    return doc || this.create({data});\n  }\n\n  ///////////////\n  // Core:Read //\n  ///////////////\n\n  exists (/* {id, assert = false} */) {\n    throw new Error('Collection child class must implement .exists');\n  }\n\n  existsAssert ({id}) {\n    return this.exists({id, assert: true});\n  }\n\n  async existsAll ({ids, assert = false}) {\n    const docs = await this.getAll({ids, assert});\n    return docs.every((doc)=> !!doc);\n  }\n\n  existsAllAssert ({ids}) {\n    return this.existsAll({ids, assert: true});\n  }\n\n  get (/* {id, assert = false} */) {\n    throw new Error('Collection child class must implement .get');\n  }\n\n  getAssert ({id}) {\n    return this.get({id, assert: true});\n  }\n\n  getAll (/* {ids, assert = false} */) {\n    throw new Error('Collection child class must implement .getAll');\n  }\n\n  getAllAssert ({ids}) {\n    return this.getAll({ids, assert: true});\n  }\n\n  find (/* {query, limit, sort, start_at, start_after, select} = {} */) {\n    throw new Error('Collection child class must implement .find');\n  }\n\n  async findOne ({query, sort, select}) {\n    const docs = await this.find({\n      limit: 1,\n      query,\n      sort,\n      select\n    });\n    return (docs.length > 0) ? docs[0] : null;\n  }\n\n  async findIds ({query}) {\n    const docs = await this.find({query, select: ['id']});\n    return docs.map(({id})=> id);\n  }\n\n  async list ({limit, sort, start_at, start_after} = {}) {\n    return this.find({limit, sort, start_at, start_after});\n  }\n\n  /////////////////\n  // Core:Update //\n  /////////////////\n\n  update (/* {id, data, merge = true, assert = false} */) {\n    throw new Error('Collection child class must implement .update');\n  }\n\n  updateAssert ({id, data, merge = true}) {\n    return this.update({id, data, merge, assert: true});\n  }\n\n  async updateAll ({ids, data, merge = true, assert = false}) {\n    this._addUpdatedAt(data);\n    return Promise.map(ids, (id)=> {\n      return this.update({id, data, merge, assert});\n    });\n  }\n\n  updateAllAssert ({ids, data, merge = true}) {\n    return this.update({ids, data, merge, assert: true});\n  }\n\n  async updateMany ({query, data, merge = true}) {\n    const ids = await this.findIds({query});\n    return this.updateAll({ids, data, merge});\n  }\n\n  /////////////////\n  // Core:Delete //\n  /////////////////\n\n  delete (/* {id, assert = true} */) {\n    throw new Error('Collection child class must implement .delete');\n  }\n\n  deleteAssert ({id}) {\n    return this.delete({id, assert: true});\n  }\n\n  deleteAll (/* {ids} */) {\n    throw new Error('Collection child class must implement .deleteAll');\n  }\n\n  async deleteMany ({query}) {\n    const ids = await this.findIds({query});\n    return this.deleteAll({ids});\n  }\n\n  /////////////\n  // Loaders //\n  /////////////\n\n  get loader () {\n    return new DataLoader(async (ids)=> {\n      this.logger.debug({\n        message: `calling DataLoader for ${this.name}`,\n        ids\n      });\n\n      const docs = await this.getAll({ids});\n\n      const lookup = new Map();\n      for (const doc of docs) {\n        lookup.set(doc.id, doc);\n      }\n\n      return ids.map((id)=> {\n        return lookup.has(id) ? lookup.get(id) : null;\n      });\n    });\n  }\n\n  load (id) {\n    if (!id) {\n      throw new Error('Missing id');\n    }\n    const loader = this.getLoader(this.name);\n    return loader.load(id);\n  }\n\n  loadMany (ids) {\n    if (!ids.length) {\n      return [];\n    }\n    const loader = this.getLoader(this.name);\n    return loader.loadMany(ids);\n  }\n\n  async loadManyCompact (ids) {\n    const docs = await this.loadMany(ids);\n    return compact(docs);\n  }\n\n  /////////////\n  // Helpers //\n  /////////////\n\n  _timestamp () {\n    return new Date();\n  }\n\n  _addTimestamps (obj, time) {\n    if (!time) {\n      time = this._timestamp();\n    }\n    this._addCreatedAt(obj, time);\n    this._addUpdatedAt(obj, time);\n    return obj;\n  }\n\n  _addCreatedAt (obj, time) {\n    if (!('created_at' in obj)) {\n      obj.created_at = time || this._timestamp();\n    }\n    return obj;\n  }\n\n  _addUpdatedAt (obj, time) {\n    if (!('updated_at' in obj)) {\n      obj.updated_at = time || this._timestamp();\n    }\n    return obj;\n  }\n}\n\nsingleton(Collection);\n","export default function timestampsToDates (obj) {\n  if (!obj) {\n    return obj;\n  }\n  const type = obj.constructor.name;\n  switch (type) {\n    case 'Array':\n      return obj.map(timestampsToDates);\n    case 'Object':\n      return Object.keys(obj).reduce((result, k)=> {\n        result[k] = timestampsToDates(obj[k]);\n        return result;\n      }, {});\n    case 'Timestamp':\n      return obj.toDate();\n    default:\n      return obj;\n  }\n}\n","import {ApolloError} from 'apollo-server-cloud-functions';\n\nexport class GraphQLError extends ApolloError {\n  constructor ({\n    code = 'GraphQLError',\n    message = 'GraphQL error',\n    params\n  } = {}) {\n    if (message.constructor === Function) {\n      message = message(params);\n    }\n    super(message, code, params);\n    this.expected = true;\n  }\n\n  is (code) {\n    return (this.code === code);\n  }\n}\n\nexport class DoesNotExistError extends GraphQLError {\n  constructor (params) {\n    super({\n      code: 'DoesNotExist',\n      message: ({type, id, ids, query})=> {\n        let missing = '';\n        if (id) {\n          missing = ` for id = ${id}`;\n        } else if (ids) {\n          missing = ` for ids = [${ids.join(',')}]`;\n        } else if (query) {\n          missing = ` for query = ${query}`;\n        }\n        return `Could not find ${type}${missing}`;\n      },\n      params\n    });\n  }\n}\n\nexport class NotAuthorizedError extends GraphQLError {\n  constructor (params) {\n    super({\n      code: 'NotAuthorized',\n      message: `Not authorized to access ${params.path}`,\n      params\n    });\n  }\n}\n","import {omit, uniq, isNumber, isObject} from 'lodash';\n\nimport Collection from './Collection';\nimport timestampsToDates from './timestampsToDates';\nimport {DoesNotExistError} from '../Errors';\n\nexport default class FirestoreCollection extends Collection {\n  constructor (options) {\n    super(options);\n    const {Admin, app} = options;\n    this.Admin = Admin;\n    this.app = app;\n  }\n\n  get auth () {\n    return this.app.auth();\n  }\n\n  get collection () {\n    return this.app.firestore().collection(this.name);\n  }\n\n  doc (id) {\n    return this.collection.doc(id);\n  }\n\n  /////////////////\n  // Core:Create //\n  /////////////////\n\n  async create ({data}) {\n    return this.add({data});\n  }\n\n  ///////////////\n  // Core:Read //\n  ///////////////\n\n  async exists ({id, assert = false}) {\n    const ref = this.doc(id);\n    const snap = await ref.get();\n    const {exists} = snap;\n    if (assert && !exists) {\n      const type = this.name();\n      throw new DoesNotExistError({type, id});\n    }\n    return exists;\n  }\n\n  async get ({id, assert = false}) {\n    const ref = this.doc(id);\n    const snap = await ref.get();\n    if (assert && !snap.exists) {\n      const type = this.name();\n      throw new DoesNotExistError({type, id});\n    }\n    return this._snapToDoc(snap);\n  }\n\n  async getAll ({ids, assert = false}) {\n    if (!ids || ids.length === 0) {\n      return [];\n    }\n\n    const uniques = uniq(ids);\n    const refs = uniques.map((id)=> this.doc(id));\n    const snaps = await this.firestore.getAll(refs);\n    const docs = snaps.map((snap)=> this._snapToDoc(snap));\n\n    const docs_by_id = {};\n    for (const doc of docs) {\n      if (doc) {\n        docs_by_id[doc.id] = doc;\n      }\n    }\n\n    const missing_ids = [];\n    const result = ids.map((id)=> {\n      const exists = (id in docs_by_id);\n      if (!exists) {\n        missing_ids.push(id);\n      }\n      return exists ? docs_by_id[id] : null;\n    });\n\n    if (assert && missing_ids.length) {\n      throw new DoesNotExistError({\n        type: this.name,\n        ids: missing_ids\n      });\n    } else {\n      return result;\n    }\n  }\n\n  async find ({query, limit, sort, start_at, start_after, select} = {}) {\n    let cursor = this.collection;\n\n    function invalid (field) {\n      throw new Error(`Invalid ${field} for find`);\n    }\n\n    if (query) {\n      let parts;\n      if (isObject(query)) {\n        parts = Object.entries(query).map(([field, value])=> {\n          return [field, '==', value];\n        });\n      } else if (Array.isArray(query)) {\n        parts = Array.isArray(query[0]) ? query : [query];\n      } else {\n        invalid('query');\n      }\n\n      for (const part of parts) {\n        if (part.length !== 3) {\n          invalid('query');\n        }\n        const [field, op, value] = part;\n        cursor = cursor.where(field, op, value);\n      }\n    }\n\n    if (sort) {\n      if (!Array.isArray(sort)) {\n        sort = [sort];\n      }\n      cursor = cursor.orderBy(...sort);\n    }\n\n    const start = start_after || start_at;\n    if (start) {\n      const doc = await this.doc(start).get();\n      const fn = start_after ? 'startAfter' : 'startAt';\n      cursor = cursor[fn](doc);\n    }\n\n    if (limit) {\n      if (!isNumber(limit)) {\n        invalid('limit');\n      }\n      cursor = cursor.limit(limit);\n    }\n\n    if (select) {\n      if (!Array.isArray(select)) {\n        invalid('select');\n      }\n      cursor = cursor.select(...select);\n    }\n\n    const snap = await cursor.get();\n    return snap.docs.map(this._snapToDoc);\n  }\n\n  /////////////////\n  // Core:Update //\n  /////////////////\n\n  async update (args) {\n    return this.set(args);\n  }\n\n  /////////////////\n  // Core:Delete //\n  /////////////////\n\n  async delete ({id, assert = true}) {\n    if (assert) {\n      await this.existsAssert({id});\n    }\n    const ref = this.doc(id);\n    return ref.delete();\n  }\n\n  deleteAll ({ids}) {\n    const batch = this.Admin.firestore.batch();\n    for (const id of ids) {\n      const ref = this.doc(id);\n      batch.delete(ref);\n    }\n    return batch.commit();\n  }\n\n  ///////////////\n  // Auxiliary //\n  ///////////////\n\n  async add ({data}) {\n    data = omit(data, 'id');\n    this._addTimestamps(data);\n    const ref = await this.collection.add(data);\n    data.id = ref.id;\n    return data;\n  }\n\n  async getOrAddById ({id, data, add = (x)=> x}) {\n    let user = await this.get({id});\n    if (!user) {\n      data = await add(data);\n      user = await this.set({id, data, merge: false});\n    }\n    return user;\n  }\n\n  findOneByField (field) {\n    return (value)=> {\n      return this.findOne({\n        query: [field, '==', value]\n      });\n    };\n  }\n\n  async set ({\n    id,\n    data,\n    merge = true,\n    assert = false,\n    get = true\n  }) {\n    if (assert) {\n      await this.existsAssert({id});\n    }\n    data = omit(data, 'id');\n    this._addUpdatedAt(data);\n    const ref = this.doc(id);\n    const set = await ref.set(data, {merge});\n    return get ? this.get({id}) : set;\n  }\n\n  async addOrSetByField ({\n    field,\n    data,\n    add = (x)=> x\n  }) {\n    const value = data[field];\n    const doc = await this.findOneByField(field)(value);\n    if (doc) {\n      const {id} = doc;\n      return this.set({id, data});\n    } else {\n      data = await add(data);\n      return this.add({data});\n    }\n  }\n\n  /////////////\n  // Helpers //\n  /////////////\n\n  _timestamp () {\n    return this.Admin.firestore.FieldValue.serverTimestamp();\n  }\n\n  _deleteField () {\n    return this.Admin.firestore.FieldValue.delete();\n  }\n\n  _snapToDoc (snap) {\n    if (snap.exists) {\n      const data = snap.data();\n      data.id = snap.id;\n      return timestampsToDates(data);\n    } else {\n      return null;\n    }\n  }\n\n  _id () {\n    const ref = this.collection.doc();\n    return ref.id;\n  }\n}\n","export function isExisting ({context}) {\n  return !!context.user;\n}\n\nexport function isSignedIn ({context}) {\n  return !!context.user_id;\n}\n\nexport function isPublic () {\n  return true;\n}\n","// TODO: move this to utils, would be generally useful\nfunction instanceGetter ({Constructors, options}) {\n  return function getter (name) {\n    const Constructor = Constructors[name];\n    if (!Constructor) {\n      const msg = `Constructor with name ${name} does not exist`;\n      throw new Error(msg);\n    }\n    return Constructor.instance(options);\n  };\n}\n\nexport default function processOptions (input) {\n  const {Services, Collections, ...options} = input;\n\n  options.getService = instanceGetter({\n    Constructors: Services,\n    options\n  });\n\n  options.getCollection = instanceGetter({\n    Constructors: Collections,\n    options\n  });\n\n  return options;\n}\n","export default function getToken (request) {\n  const header = request.get('Authorization');\n  const prefix = /^Bearer /;\n  if (header && header.match(prefix)) {\n    return header.replace(prefix, '');\n  } else {\n    return null;\n  }\n}\n","import base_logger from '../../logger';\nimport processOptions from '../processOptions';\nimport getTokenDefault from './getToken';\n\nexport default function contextBuilder ({\n  loadSession,\n  getToken = getTokenDefault,\n  start = ()=> {},\n  ...options\n}) {\n  return async ({req} = {})=> {\n    // TODO: support serializers in logger\n    const logger = base_logger.child('contextBuilder');\n\n    await start();\n\n    options = processOptions(options);\n    const {getCollection} = options;\n\n    const loaders = {};\n    function getLoader (arg) {\n      const name = arg.name || arg;\n      if (!(name in loaders)) {\n        const collection = getCollection(name);\n        loaders[name] = collection.loader;\n      }\n      return loaders[name];\n    }\n\n    let session_id = null;\n    let user_id = null;\n    let user = null;\n    let load_user_error = null;\n\n    const token = getToken(req);\n    if (token) {\n      try {\n        ({session_id, user_id, user} = await loadSession({token, getCollection}));\n        logger.debug('Loaded session', {session_id, user});\n      } catch (error) {\n        logger.error('Error loading session', error);\n        load_user_error = error;\n      }\n    }\n\n    return {\n      session_id,\n      user_id,\n      user,\n      load_user_error,\n      getLoader,\n      ...options\n    };\n  };\n}\n","import * as GraphQL from 'graphql';\n\nimport logger from '../../logger';\nimport {GraphQLError} from '../../Errors';\n\nexport default function formatError (error) {\n  logger.error(error);\n\n  let data = GraphQL.formatError(error);\n\n  const {originalError: oerror} = error;\n  if (oerror && oerror.expected) {\n    data.code = oerror.code;\n  } else {\n    // Handle context creation errors don't include original\n    // const missing = error.message.match(/Missing session user ([^\\s]{24})/);\n    // let public_error;\n    // if (missing) {\n    //   const id = missing[1];\n    //   public_error = new Errors.SessionUserMissing({id});\n    // } else {\n    //   public_error = new Errors.Public();\n    // }\n    const public_error = new GraphQLError();\n    data = GraphQL.formatError(public_error);\n    data.code = public_error.code;\n  }\n\n  return data;\n}\n","import {merge} from 'lodash';\n\nimport logger from '../../logger';\n\nexport default function exposeResolvers ({Controllers, Scalars, options}) {\n  const resolvers = {};\n  for (const [name, Controller] of Object.entries(Controllers)) {\n    logger.debug(`Exposing controller ${name}`);\n    const controller = new Controller(options);\n    merge(resolvers, controller.expose());\n  }\n  merge(resolvers, Scalars);\n  return resolvers;\n}\n","import {makeExecutableSchema} from 'graphql-tools';\nimport {ApolloServer} from 'apollo-server-cloud-functions';\n\nimport processOptions from '../processOptions';\nimport formatErrorDefault from './formatError';\nimport exposeResolvers from './exposeResolvers';\n\nfunction makeSchema ({Schema, Controllers, Scalars, options}) {\n  const resolvers = exposeResolvers({Controllers, Scalars, options});\n  return makeExecutableSchema({\n    typeDefs: Schema,\n    resolvers\n  });\n}\n\nexport default function createGraphqlHandler ({\n  Controllers,\n  Scalars,\n  Schema,\n  options = {}\n}) {\n  const {\n    server: opts_server = {},\n    handler: opts_handler = {},\n    controller: opts_controller = {}\n  } = options;\n\n  if (!opts_server.formatError) {\n    opts_server.formatError = formatErrorDefault;\n  }\n\n  const schema = makeSchema({\n    options: processOptions(opts_controller),\n    Schema,\n    Controllers,\n    Scalars\n  });\n\n  const server = new ApolloServer({...opts_server, schema});\n  return server.createHandler(opts_handler);\n}\n","import {isFunction} from 'lodash';\n\nimport initialize from '../../initialize';\nimport {\n  GraphQLError,\n  NotAuthorizedError\n} from '../../Errors';\n\n// to: helpers\nfunction capitalize (str) {\n  return str[0].toUpperCase() + str.slice(1);\n}\n\nconst APOLLO_UNION_RESOLVER_NAME = '__resolveType';\n\nexport default class GraphQLController {\n  constructor (options) {\n    // Only initialize if options are passed (we skip when building schema)\n    if (options) {\n      initialize.call(this, {namespace: 'GraphQLController', ...options});\n    }\n  }\n\n  get name () {\n    throw new Error('Child class must implement .name');\n  }\n\n  resolvers () {\n    // Child class should implement this method and return\n    // an object with this shape:\n    //\n    // {\n    //   // Mutations resolved in this controller\n    //   Mutation: {\n    //     <MutationName>: {\n    //       resolver: Function,\n    //       authorizer: Function\n    //     }\n    //   },\n    //   // Queries resolved in this controller\n    //   Query: {\n    //     <QueryName>: {\n    //       resolver: Function,\n    //       authorizer: Function\n    //     }\n    //   },\n    //   // Type fields resolved in this controller\n    //   <TypeName>: {\n    //     <FieldName>: {\n    //       resolver: Function,\n    //       authorizer: Function\n    //     }\n    //   },\n    //   <UnionTypeName>: {\n    //     __resolveType: Function\n    //   }\n    // }\n    throw new Error('Child class must implement .resolvers');\n  }\n\n  collection (name) {\n    return this.getCollection(name || this.name);\n  }\n\n  expose () {\n    const {logger} = this;\n\n    const result = {};\n\n    const groups = this.resolvers();\n    for (const [type, group] of Object.entries(groups)) {\n      if (!(type in result)) {\n        result[type] = {};\n      }\n\n      for (const [name, definition] of Object.entries(group)) {\n        const path = `${type}.${name}`;\n\n        // Resolve Union types\n        // https://www.apollographql.com/docs/graphql-tools/resolvers/#unions-and-interfaces\n        if (name === APOLLO_UNION_RESOLVER_NAME) {\n          result[type][name] = (obj, context, info)=> {\n            return definition.call(this, {obj, context, info});\n          };\n          continue;\n        }\n\n        // This seems like a dumb idea unless there's some dynmamic thing that\n        // is difficult to do without this..\n        // let the resolvers and permission be specified as strings\n        // for (const [k, v] of Object.entries(config)) {\n        //   if (Type(v, String)) {\n        //     config[k] = this[v];\n        //   }\n        // }\n\n        for (const field of ['authorizer', 'resolver']) {\n          if (!isFunction(definition[field])) {\n            throw new Error(`Invalid ${field} definition for ${path}`);\n          }\n        }\n\n        const {resolver, authorizer} = definition;\n        result[type][name] = async (obj, args, context, info)=> {\n          const {user} = context;\n          const params = {obj, args, context, info, user};\n\n          const rlogger = logger.child({\n            resolver: name,\n            type,\n            user\n          });\n\n          rlogger.debug(`Calling resolver ${path}`);\n\n          try {\n            // Have to handle this explicitly, would be better to have\n            // this in context build derp meh\n            const {load_user_error} = context;\n            if (load_user_error) {\n              throw load_user_error;\n            }\n\n            const authorized = await authorizer.call(this, params);\n            if (!authorized) {\n              const error = new NotAuthorizedError({path});\n              rlogger.error(error);\n              throw error;\n            }\n\n            rlogger.info('Calling resolver', {obj, args});\n            return resolver.call(this, params);\n          } catch (error) {\n            if (error.expected) {\n              rlogger.error('Expected GraphQL error', error);\n              throw error;\n            } else {\n              rlogger.error(error);\n              throw new GraphQLError();\n            }\n          }\n        };\n      }\n    }\n    return result;\n  }\n\n  load ({collection, field}) {\n    return ({obj, context})=> {\n      const loader = context.getLoader(collection);\n      const id = obj[field];\n      return id ? loader.load(id) : null;\n    };\n  }\n\n  loadMany ({collection, field}) {\n    return ({obj, context})=> {\n      const loader = context.getLoader(collection);\n      const ids = obj[field];\n      return ids.length ? loader.loadMany(ids) : [];\n    };\n  }\n\n  resolveType (getType) {\n    return ({obj, info})=> {\n      const type = getType(obj);\n      return info.schema.getType(type);\n    };\n  }\n\n  stub () {\n    throw new Error('Unimplemented stub');\n  }\n\n  ///////////////////////\n  // Generic Resolvers //\n  ///////////////////////\n\n  exists = this._toCollection('exists');\n  get    = this._toCollection('get');\n  list   = this._toCollection('list');\n  create = this._wrapToCollection('create')\n  update = this._wrapToCollection('update');\n\n  async delete (request) {\n    if (this.beforeDelete) {\n      await this.beforeDelete(request);\n    }\n\n    const {id} = request.args;\n    const collection = this.collection(request);\n    const deleted = await collection.delete({id});\n    const deleted_at = new Date();\n\n    if (this.afterDelete) {\n      await this.afterDelete({...request, deleted, deleted_at});\n    }\n\n    return {deleted_at, deleted};\n  }\n\n  _toCollection (method) {\n    return (request)=> {\n      const collection = this.collection(request);\n      return collection[method](request.args);\n    };\n  }\n\n  _wrapToCollection (method) {\n    const cmethod = capitalize(method);\n    const before = `before${cmethod}`;\n    const after = `after${cmethod}`;\n\n    return async (request)=> {\n      const collection = this.collection(request);\n\n      let {data} = request.args;\n      if (this[before]) {\n        data = await this[before](request);\n      }\n\n      let doc = await collection[method]({data});\n      if (this[after]) {\n        doc = await this[after]({...request, data, doc});\n      }\n\n      return doc;\n    };\n  }\n}\n","import {get, difference} from 'lodash';\n\nimport exposeResolvers from './exposeResolvers';\n\n// We group definitions by their kind and also build up some enums that\n// can be written to the shared package so we can use those instead of\n// magic strings in the applications\nfunction processDefinitions (definitions) {\n  const enums = {};\n  const groups = {\n    Query: [],\n    Mutation: [],\n    Type: []\n  };\n\n  for (const definition of definitions) {\n    const {kind} = definition;\n    const name = get(definition, 'name.value');\n    if (!name) {\n      continue;\n    }\n\n    switch (kind) {\n      case 'ScalarTypeDefinition':\n      case 'InterfaceTypeDefinition':\n      case 'UnionTypeDefinition':\n        groups.Type.push(name);\n        break;\n\n      case 'EnumTypeDefinition': {\n        const {values} = definition;\n        enums[name] = values.reduce((result, value_definition)=> {\n          const {value} = value_definition.name;\n          result[value] = value;\n          return result;\n        }, {});\n        break;\n      }\n\n      case 'ObjectTypeDefinition': {\n        const is_query_or_mutation = ['Query', 'Mutation'].includes(name);\n        if (is_query_or_mutation) {\n          const {fields} = definition;\n          for (const field of fields) {\n            const {value} = field.name;\n            groups[name].push(value);\n          }\n        } else {\n          groups.Type.push(name);\n        }\n        break;\n      }\n\n      default:\n        break;\n    }\n  }\n\n  return {enums, groups};\n}\n\n// TODO: handle checking resolved type fields as well by using @ref directive\nfunction checkSchema ({groups: schema_groups, resolvers}) {\n  const resolver_groups = Object.entries(resolvers).reduce((names, [k, v])=> {\n    if (k in names) {\n      names[k] = Object.keys(v);\n    } else {\n      names.Type.push(k);\n    }\n    return names;\n  }, {\n    Type: [],\n    Query: null,\n    Mutation: null\n  });\n\n  return Object.entries(schema_groups).reduce((errors, [kind, schema_names])=> {\n    const resolver_names = resolver_groups[kind];\n    const differences = {\n      resolver: difference(schema_names, resolver_names),\n      schema: difference(resolver_names, schema_names)\n    };\n\n    return Object.entries(differences).reduce((errors, [source, diff])=> {\n      const new_errors = diff.map((name)=>\n        `Missing ${source} for ${name}`\n      );\n      return [...errors, ...new_errors];\n    }, errors);\n  }, []);\n}\n\nexport default function processSchema ({Schema, Controllers, Scalars}) {\n  const resolvers = exposeResolvers({Controllers, Scalars});\n  const {definitions} = Schema;\n  const {enums, groups} = processDefinitions(definitions);\n  const errors = checkSchema({resolvers, groups});\n  return {enums, groups, errors};\n}\n","import Express from 'express';\nimport Cors from 'cors';\n\nimport processOptions from '../processOptions';\n\nexport default function createHttpHandler ({Handler, options}) {\n  const app = Express();\n  const cors = Cors(options.cors);\n  app.use(cors);\n\n  options = processOptions(options.handler);\n  const handler = new Handler(options);\n  handler.expose(app);\n\n  return app;\n}\n","import initialize from '../initialize';\n\nexport default class Handler {\n  constructor ({start, ...options}) {\n    this.start = start;\n    initialize.call(this, {namespace: 'Handler', ...options});\n  }\n\n  get name () {\n    throw new Error('Child class must implement .name');\n  }\n\n  actions () {\n    throw new Error('Handler should implement actions');\n  }\n\n  expose () {\n    throw new Error('Handler should implement expose');\n  }\n}\n","import Handler from '../Handler';\n\nexport default class HttpHandler extends Handler {\n  expose (app) {\n    let actions = this.actions();\n    if (!Array.isArray(actions)) {\n      actions = Object.entries(actions).map(([route, action])=> {\n        if (!route.includes(' ')) {\n          route = `GET ${route}`;\n        }\n        const [method, path] = route.split(/\\s+/);\n        return {method, path, action};\n      });\n    }\n\n    for (const {method, path, action} of actions) {\n      const fn = method.toLowerCase();\n      app[fn](path, this.handle(action));\n    }\n\n    return app;\n  }\n\n  handle (action) {\n    return async (request, response)=> {\n      await this.start();\n\n      const {params} = request;\n      const logger = this.logger.child({action, params});\n\n      try {\n        logger.info('Handler running');\n        const method = this[action].bind(this);\n        const data = await method({params, request, response});\n        logger.info('Handler success', {data});\n        return response.json(data);\n      } catch (error) {\n        logger.error('Handler failure', error);\n        return response\n          .status(error.status || 500)\n          .json({error: error.message});\n      }\n    };\n  }\n}\n","import processOptions from '../processOptions';\n\nexport default function createPubSubHandler ({Handler, options}) {\n  options = processOptions(options.handler);\n  const handler = new Handler(options);\n  return handler.expose();\n}\n","import Handler from '../Handler';\n\nexport default class PubSubHandler extends Handler {\n  expose (topic) {\n    let actions = this.actions(topic);\n    if (!Array.isArray(actions)) {\n      actions = Object.entries(actions).map(([topic, action])=> {\n        return {topic, action};\n      });\n    }\n\n    return actions.map(({topic, action})=> {\n      const handler = this.handle(action);\n      return {topic, handler};\n    });\n  }\n\n  handle (action) {\n    return async (message, context)=> {\n      await this.start();\n\n      const {json, data, attributes} = message;\n      const logger = this.logger.child({action, message, context});\n\n      try {\n        logger.info('Handler running');\n        const method = this[action].bind(this);\n        const response = await method({json, data, attributes, context});\n        logger.info('Handler success', response);\n      } catch (error) {\n        logger.error('Handler failure', error);\n      }\n    };\n  }\n}\n","import {graphql} from 'graphql';\n\nimport logger from './logger';\n\n// https://graphql.org/graphql-js/graphql/#graphql\n// graphql(\n//   schema: GraphQLSchema,\n//   requestString: string,\n//   rootValue?: ?any,\n//   contextValue?: ?any,\n//   variableValues?: ?{[key: string]: any},\n//   operationName?: ?string\n// ): Promise<GraphQLResult>\n\nexport default async function directGraphqlRequest ({Schema, context, query, variables}) {\n  const rlogger = logger.child({\n    name: 'localGraphqlRequest',\n    query,\n    variables\n  });\n  rlogger.debug('Making request');\n\n  const root = {};\n  const response = await graphql(Schema, query, root, context, variables);\n  const {data, errors} = response;\n\n  if (errors) {\n    const error = errors[0];\n    rlogger.error(error);\n    throw error;\n  } else {\n    rlogger.debug('Got response', {data});\n    return data;\n  }\n}\n"],"names":["logger","Logger","initialize","options","namespace","required","name","Error","default_logger","child","Collection","constructor","call","bucket","Admin","storage","collection","create","createAll","datas","Promise","map","data","findOrCreate","query","findOne","doc","exists","existsAssert","id","assert","existsAll","ids","getAll","docs","every","existsAllAssert","get","getAssert","getAllAssert","find","sort","select","limit","length","findIds","list","start_at","start_after","update","updateAssert","merge","updateAll","_addUpdatedAt","updateAllAssert","updateMany","delete","deleteAssert","deleteAll","deleteMany","loader","DataLoader","debug","message","lookup","Map","set","has","load","getLoader","loadMany","loadManyCompact","compact","_timestamp","Date","_addTimestamps","obj","time","_addCreatedAt","created_at","updated_at","singleton","timestampsToDates","type","Object","keys","reduce","result","k","toDate","GraphQLError","ApolloError","code","params","Function","expected","is","DoesNotExistError","missing","join","NotAuthorizedError","path","FirestoreCollection","app","auth","firestore","add","ref","snap","_snapToDoc","uniques","uniq","refs","snaps","docs_by_id","missing_ids","push","isNumber","invalid","cursor","Array","isArray","field","parts","isObject","entries","value","part","op","where","orderBy","start","fn","args","batch","commit","omit","getOrAddById","x","user","findOneByField","addOrSetByField","FieldValue","serverTimestamp","_deleteField","_id","isExisting","context","isSignedIn","user_id","isPublic","instanceGetter","Constructors","getter","Constructor","msg","instance","processOptions","input","Services","Collections","getService","getCollection","getToken","request","header","prefix","match","replace","body","recover","e","then","contextBuilder","loadSession","getTokenDefault","req","base_logger","session_id","load_user_error","arg","loaders","token","error","formatError","GraphQL","originalError","oerror","public_error","exposeResolvers","Controllers","Scalars","resolvers","Controller","controller","expose","makeSchema","Schema","makeExecutableSchema","typeDefs","createGraphqlHandler","server","opts_server","handler","opts_handler","opts_controller","formatErrorDefault","schema","ApolloServer","createHandler","capitalize","str","toUpperCase","slice","APOLLO_UNION_RESOLVER_NAME","GraphQLController","_toCollection","_wrapToCollection","groups","group","definition","info","isFunction","resolver","authorizer","rlogger","authorized","resolveType","getType","stub","deleted","deleted_at","afterDelete","beforeDelete","method","cmethod","before","after","processDefinitions","definitions","enums","Query","Mutation","Type","kind","values","value_definition","is_query_or_mutation","includes","fields","checkSchema","schema_groups","resolver_groups","names","v","errors","schema_names","resolver_names","differences","difference","source","diff","new_errors","processSchema","createHttpHandler","Handler","Express","cors","Cors","use","actions","HttpHandler","route","action","split","toLowerCase","handle","response","bind","json","status","createPubSubHandler","PubSubHandler","topic","attributes","directGraphqlRequest","variables","root","graphql"],"mappings":"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"}