import e from"firebase-admin";import r from"dataloader";import{omit as t,uniq as n,isObject as o,isNumber as i,isFunction as c,merge as a}from"lodash";import{ApolloError as u,ApolloServer as s}from"apollo-server-cloud-functions";import{https as l}from"firebase-functions";import{makeExecutableSchema as d}from"graphql-tools";var f={__proto__:null,isSignedIn:function(e){return!!e.context.user_id},isPublic:function(){return!0}};function h(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,r,t){return r&&h(e.prototype,r),t&&h(e,t),e}function m(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r}function p(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function g(e){var r=0;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=function(e,r){if(e){if("string"==typeof e)return p(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?p(e,void 0):void 0}}(e)))return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function y(e){if(!e)return e;switch(e.constructor.name){case"Array":return e.map(y);case"Object":return Object.keys(e).reduce(function(r,t){return r[t]=y(e[t]),r},{});case"Timestamp":return e.toDate();default:return e}}for(var w=function(e){function r(r){var t,n=r.code,o=void 0===n?"GraphQLError":n,i=r.message,c=void 0===i?"GraphQL error":i,a=r.params;return c.constructor===Function&&(c=c(a)),(t=e.call(this,c,o,a)||this).expected=!0,t}return m(r,e),r.prototype.is=function(e){return this.code===e},r}(u),b=function(e){function r(r){return e.call(this,{code:"DocumentDoesNotExist",message:"Document "+r.type+" with id "+r.id+" does not exist",params:r})||this}return m(r,e),r}(w),_=function(e){function r(r){return e.call(this,{code:"ResolverMissing",message:"Resolver missing: "+r.path,params:r})||this}return m(r,e),r}(w),P=function(e){function r(r){return e.call(this,{code:"ResolverAuthorizerMissing",message:"Resolver permission missing: "+r.path,params:r})||this}return m(r,e),r}(w),j=function(e){function r(r){return e.call(this,{code:"SessionUserNotFound",message:"Session user not found: "+r.id,params:r})||this}return m(r,e),r}(w),x=function(e){function r(r){return e.call(this,{code:"NotAuthorized",message:"Not authorized to access "+r.path,params:r})||this}return m(r,e),r}(w),A=function(e){function r(r){return e.call(this,{code:"AuthToken",message:"Auth token error "+r.code+": "+r.message,params:r})||this}return m(r,e),r}(w),E={__proto__:null,GraphQLError:w,DocumentDoesNotExistError:b,ResolverMissingError:_,ResolverAuthorizerMissingError:P,SessionUserNotFoundError:j,NotAuthorizedError:x,AuthTokenError:A},S=function(){function c(e){var r=e.getLoader;this.getCollection=e.getCollection,this.getLoader=r}c.get=function(e){return new this(e)};var a=c.prototype;return a.doc=function(e){return this.collection.doc(e)},a.add=function(e){var r=e.data;try{r=t(r,"id");var n=this._timestampField();return r.created_at=n,r.updated_at=n,Promise.resolve(this.collection.add(r)).then(function(e){return r.id=e.id,r})}catch(e){return Promise.reject(e)}},a.set=function(e){var r=e.id,n=e.data,o=e.merge,i=void 0===o||o;try{var c=this;(n=t(n,"id")).updated_at=c._timestampField();var a=c.doc(r);return Promise.resolve(a.set(n,{merge:i})).then(function(){return c.get({id:r})})}catch(e){return Promise.reject(e)}},a.addOrSetByField=function(e){var r=e.field,t=e.data,n=e.add,o=void 0===n?function(e){return e}:n;try{var i=this,c=t[r];return Promise.resolve(i.findOneByField(r)(c)).then(function(e){return e?i.set({id:e.id,data:t}):Promise.resolve(o(t)).then(function(e){return i.add({data:t=e})})})}catch(e){return Promise.reject(e)}},a.getOrAddById=function(e){var r=e.id,t=e.data,n=e.add,o=void 0===n?function(e){return e}:n;try{var i=this;return Promise.resolve(i.get({id:r})).then(function(e){var n=function(){if(!e)return Promise.resolve(o({id:r,data:t})).then(function(n){return t=n,Promise.resolve(i.set({id:r,data:t,merge:!1})).then(function(r){e=r})})}();return n&&n.then?n.then(function(){return e}):e})}catch(e){return Promise.reject(e)}},a.exists=function(e){try{var r=this.doc(e);return Promise.resolve(r.get()).then(function(e){return e.exists})}catch(e){return Promise.reject(e)}},a.get=function(e){var r=e.id,t=e.assert,n=void 0!==t&&t;try{var o=this,i=o.doc(r);return Promise.resolve(i.get()).then(function(e){if(n&&!e.exists)throw o._doesNotExistError(r);return o._snapToDoc(e)})}catch(e){return Promise.reject(e)}},a.getMany=function(e){var r=e.ids;try{var t=this;if(!r||0===r.length)return Promise.resolve([]);var o=n(r).map(function(e){return t.doc(e)});return Promise.resolve(t.db.getAll(o)).then(function(e){for(var n,o=e.map(function(e){return t._snapToDoc(e)}),i={},c=g(o);!(n=c()).done;){var a=n.value;a&&(i[a.id]=a)}return r.map(function(e){return e in i?i[e]:null})})}catch(e){return Promise.reject(e)}},a.find=function(e){var r=void 0===e?{}:e,t=r.where,n=r.limit,c=r.order_by,a=r.select;try{var u,s,l=this,d=function(e){throw new Error("Invalid "+e+" for find")},f=l.collection;if(t){var h;o(t)?h=Object.entries(t).map(function(e){return[e[0],"==",e[1]]}):Array.isArray(t)?h=Array.isArray(t[0])?t:[t]:d("where");for(var v,m=g(h);!(v=m()).done;){var p=v.value;3!==p.length&&d("where"),f=f.where(p[0],p[1],p[2])}}return c&&(Array.isArray(c)||(c=[c]),f=(u=f).orderBy.apply(u,c)),n&&(i(n)||d("limit"),f=f.limit(n)),a&&(Array.isArray(a)||d("select"),f=(s=f).select.apply(s,a)),Promise.resolve(f.get()).then(function(e){return e.docs.map(l._snapToDoc)})}catch(e){return Promise.reject(e)}},a.findOne=function(e){var r=e.where,t=e.order_by,n=e.select;try{return Promise.resolve(this.find({limit:1,where:r,order_by:t,select:n})).then(function(e){return e.length>0?e[0]:null})}catch(e){return Promise.reject(e)}},a.findOneByField=function(e){var r=this;return function(t){return r.findOne({where:[e,"==",t]})}},a.delete=function(e){var r=e.id,t=e.ids,n=e.where;try{var o=function(){if(0===t.length)return Promise.resolve();for(var e,r=i.db.batch(),n=g(t);!(e=n()).done;){var o=i.doc(e.value);r.delete(o)}return r.commit()},i=this;if(r){var c=i.doc(r);return Promise.resolve(c.delete())}if(t&&n)throw new Error("Delete call should pass ids or where not both");var a=function(){if(n)return Promise.resolve(i.find({where:n})).then(function(e){t=e.map(function(e){return e.id})})}();return Promise.resolve(a&&a.then?a.then(o):o())}catch(e){return Promise.reject(e)}},a._timestampField=function(){return e.firestore.FieldValue.serverTimestamp()},a._deleteField=function(){return e.firestore.FieldValue.delete()},a._snapToDoc=function(e){if(e.exists){var r=e.data();return r.id=e.id,y(r)}return null},a._doesNotExistError=function(e){var r=this.name();return new b({type:r,id:e})},a._id=function(){return this.collection.doc().id},v(c,[{key:"name",get:function(){throw new Error("Collection child class must implement .name")}},{key:"db",get:function(){return e.firestore()}},{key:"collection",get:function(){return this.db.collection(this.name)}},{key:"loader",get:function(){var e=this;return new r(function(r){return e.getMany({ids:r})})}}]),c}(),C=function(){function e(){}return e.prototype.child=function(){return this},e}(),O=function(){var e=k[T];C.prototype[e]=function(){var r,t=global,n=t.console,o=e in n?n[e]:n.log;return(r=o).call.apply(r,[n].concat([].slice.call(arguments)))}},T=0,k=["trace","debug","info","warn","error","fatal"];T<k.length;T++)O();function D(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var L=function(){function e(e){var r=(void 0===e?{}:e).logger;r||(r=new C),this.logger=r}var r=e.prototype;return r.resolvers=function(){throw new Error("Child class must implement .resolvers")},r.collection=function(e){return e.context.getCollection(e.name||this.name)},r.loader=function(e){return e.context.getLoader(e.name||this.name)},r.expose=function(){for(var e=this,r={},t=this.logger,n=this.resolvers(),o=0,i=Object.entries(n);o<i.length;o++){var a=i[o],u=a[0],s=a[1];u in r||(r[u]={});for(var l=function(){var n=f[d],o=n[0],i=n[1],a=u+"."+o;if("__resolveType"===o)return r[u][o]=function(r,t,n){return i.call(e,{obj:r,context:t,info:n})},"continue";var s=i.resolver,l=i.authorizer;if(![s,l].every(c))throw new Error("Invalid resolver definition for "+a);r[u][o]=function(r,n,o,i){try{return t.debug("Calling resolver "+a),Promise.resolve(D(function(){if(!s)throw new _({path:a});if(!l)throw new P({path:a});var t={obj:r,args:n,context:o,info:i},c=o.auth_error;if(c)throw c;return Promise.resolve(l.call(e,t)).then(function(r){if(!r)throw new x({path:a});return s.call(e,t)})},function(e){throw e.expected?(t.error(e,"Expected GraphQL error"),e):(t.error(e,"Unexpected GraphQL error"),new w)}))}catch(e){return Promise.reject(e)}}},d=0,f=Object.entries(s);d<f.length;d++)l()}return r},r.get=function(e){return this.collection(e).get(e.args)},r.list=function(e){return this.collection(e).list(e.args)},r.create=function(e){return this.collection(e).add(e.args.data)},r.update=function(e){var r=this.collection(e),t=e.args;return r.set({id:t.id,data:t.data})},r.delete=function(e){return this.collection(e).delete({id:e.args.id})},r.load=function(e){var r=e.collection,t=e.field;return function(e){var n=e.obj,o=e.context.getLoader(r),i=n[t];return i?o.load(i):null}},r.loadMany=function(e){var r=e.collection,t=e.field;return function(e){var n=e.obj,o=e.context.getLoader(r),i=n[t];return i.length?o.loadMany(i):[]}},r.resolveType=function(e){return function(r){var t=r.info,n=e(r.obj);return t.schema.getType(n)}},r.stub=function(){throw new Error("Unimplemented stub")},v(e,[{key:"name",get:function(){throw new Error("Child class must implement .name")}}]),e}();function F(e){var r=e.get("Authorization"),t=/^Bearer /;return r&&r.match(t)?r.replace(t,""):null}function N(r){var t=r.Schema,n=r.Scalars,o=r.Controllers,i=r.context,c=r.getToken,u=r.user_collection,f=r.options,h=void 0===f?{}:f;i||(i=function(r){var t=r.Collections,n=r.getToken,o=r.user_collection;return function(r){var i=r.req;try{var c=function(){return{getCollection:u,getLoader:a,auth_error:f,token:h,user_id:l,user:d}},a=function(e){var r=e.name||e;if(!(r in s)){var t=u(r);s[r]=t.loader}return s[r]},u=function e(r){var n=r.name||r,o=t[n];if(!o)throw new Error("Collection with name "+n+" does not exist");return o.get({getCollection:e,getLoader:a})},s={},l=null,d=null,f=null,h=n(i),v=function(){if(h){var r=function(r,t){try{var n=(i=u(o),Promise.resolve(function(r){try{var t;return Promise.resolve(function(n,o){try{var i=(t=e.auth(),Promise.resolve(t.verifyIdToken(r)).then(function(e){return e.uid}))}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(e){throw new A({code:e.code,message:e.message})}))}catch(e){return Promise.reject(e)}}(h)).then(function(e){return l=e,Promise.resolve(i.get({id:l})).then(function(e){d=e})}))}catch(e){return t(e)}var i;return n&&n.then?n.then(void 0,t):n}(0,function(e){f=e});if(r&&r.then)return r.then(function(){})}}();return Promise.resolve(v&&v.then?v.then(c):c())}catch(e){return Promise.reject(e)}}}({Collections:r.Collections,getToken:void 0===c?F:c,user_collection:void 0===u?"User":u}));var v=function(e){for(var r=e.Schema,t=e.Scalars,n={},o=0,i=Object.entries(e.Controllers);o<i.length;o++){var c=i[o],u=c[1];console.log("Exposing controller "+c[0]);var s=new u;a(n,s.expose())}return a(n,t),d({typeDefs:r,resolvers:n})}({Schema:t,Controllers:o,Scalars:n}),m=new s({schema:v,context:i}).createHandler(h);return l.onRequest(m)}function M(r){var t=(0,r.getServiceAccount)(process.env.NODE_ENV),n=e.credential.cert(t);e.initializeApp({credential:n,databaseURL:"https://"+t.project_id+".firebaseio.com"})}export{f as Authorizers,S as Collection,L as Controller,E as Errors,F as getToken,N as graphqlHandler,M as initializeFirebase};
//# sourceMappingURL=index.esm.js.map
