{"version":3,"file":"index.umd.js","sources":["../src/getGraphQLErrorCode.js","../src/Session.js","../src/PageContainer.js","../src/firebaseConfig.js","../src/getClient.js"],"sourcesContent":["import get from 'lodash.get';\n\nexport default function getGraphQLErrorCode (error) {\n  let code = get(error, 'graphQLErrors[0].extensions.code', null);\n  if (!code) {\n    code = get(error, 'networkError.result.errors[0].extensions.code', null);\n  }\n  return code;\n}\n","import * as React from 'react';\nimport {\n  createContext,\n  useContext,\n  useState,\n  useEffect\n} from 'react';\nimport PropTypes from 'prop-types';\nimport Firebase from 'firebase/app';\nimport 'firebase/auth';\n\nimport getGraphQLErrorCode from './getGraphQLErrorCode';\n\nconst SessionContext = createContext();\n\nfunction SessionProvider ({client, children, SessionUser, Loading, popup = true}) {\n  const [loaded, setLoaded] = useState(false);\n  const [error, setError] = useState(null);\n  const [user, _setUser] = useState(new SessionUser(null));\n\n  function setUser (data) {\n    const user = new SessionUser(data);\n    _setUser(user);\n  }\n\n  useEffect(()=> {\n    const auth = Firebase.auth();\n    const unsubscribe = auth.onAuthStateChanged(async (firebase_user)=> {\n      try {\n        if (firebase_user) {\n          const token = await firebase_user.getIdToken(true);\n          client.setToken(token);\n          const user = await SessionUser.load({client, token, firebase_user});\n          setUser(user);\n        } else {\n          client.clearToken();\n          setUser(null);\n        }\n      } catch (error) {\n        const code = getGraphQLErrorCode(error);\n        if (code) {\n          setError(code);\n        } else {\n          setError('Session error');\n        }\n      } finally {\n        setLoaded(true);\n      }\n    });\n\n    return ()=> {\n      unsubscribe();\n    };\n  }, []);\n\n  async function start ({email, password, provider: provider_name}) {\n    const auth = Firebase.auth();\n    const provider_method = popup ? 'signInWithPopup' : 'signInWithRedirect';\n    const dedicated_providers = ['Google', 'Facebook', 'Twitter', 'Github'];\n    const oauth_providers = ['Yahoo', 'Microsoft', 'Apple'];\n\n    function invalidMode () {\n      //throw new Error(`Invalid auth mode: ${provider_name}`);\n    }\n\n    let result;\n    if (provider_name.includes('Email')) {\n      let action;\n      if (provider_name === 'EmailSignin') {\n        action = 'signInWithEmailAndPassword';\n      } else if (provider_name === 'EmailSignup') {\n        action = 'createUserWithEmailAndPassword';\n      } else {\n        invalidMode();\n      }\n\n      result = await auth[action](email, password);\n\n      if (action === 'createUserWithEmailAndPassword') {\n        result = await auth.currentUser.sendEmailVerification();\n      }\n    } else if (dedicated_providers.includes(provider_name)) {\n      const Provider = Firebase.auth[`${provider_name}AuthProvider`];\n      const provider = new Provider();\n      result = await auth[provider_method](provider);\n    } else if (oauth_providers.includes(provider_name)) {\n      const domain = `${provider_name.toLowerCase()}.com`;\n      const provider = new Firebase.auth.OAuthProvider(domain);\n      result = await auth[provider_method](provider);\n    } else {\n      invalidMode();\n    }\n\n    return result;\n  }\n\n  function end () {\n    return Firebase.auth().signOut();\n  }\n\n  function reload () {\n    // TODO: implement reload\n  }\n\n  let $body;\n  if (loaded) {\n    $body = children({user});\n  } else {\n    $body = (\n      <Loading\n        user={user}\n        error={error}\n        reload={reload}\n      />\n    );\n  }\n\n  return (\n    <SessionContext.Provider\n      value={{\n        loaded,\n        error,\n        user,\n        start,\n        reload,\n        end\n      }}\n    >\n      {$body}\n    </SessionContext.Provider>\n  );\n}\n\nSessionProvider.propTypes = {\n  children: PropTypes.func,\n  client: PropTypes.object,\n  SessionUser: PropTypes.func,\n  Loading: PropTypes.func,\n  popup: PropTypes.bool\n};\n\nconst {Consumer: SessionConsumer} = SessionContext;\n\nfunction useSession () {\n  return useContext(SessionContext);\n}\n\nfunction useSessionUser () {\n  const session = useSession();\n  return session.user;\n}\n\nexport {\n  SessionContext,\n  SessionConsumer,\n  SessionProvider,\n  useSession,\n  useSessionUser\n};\n","import * as React from 'react';\nimport {\n  useEffect,\n  useState\n} from 'react';\nimport PropTypes from 'prop-types';\n\nexport default function PageContainer ({\n  Loading,\n  Error,\n  match,\n  client\n}) {\n  const {params, route} = match;\n  const {page: Page} = route;\n\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [data, setData] = useState(null);\n\n  useEffect(()=> {\n    let unmounted = false;\n    async function runQuery () {\n      if (unmounted) {\n        return;\n      }\n\n      if (!Page.query) {\n        setLoading(false);\n        return;\n      }\n\n      try {\n        const page_query = Page.query(params);\n        const {data} = await client.query(page_query);\n        setData(data);\n      } catch (error) {\n        setError(error);\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    runQuery();\n\n    return ()=> {\n      unmounted = true;\n    };\n  }, []);\n\n  let body;\n  if (loading) {\n    body = (\n      <Loading/>\n    );\n  } else if (error) {\n    body = (\n      <Error error={error}/>\n    );\n  } else {\n    body = (\n      <Page\n        params={params}\n        route={route}\n        {...data}\n      />\n    );\n  }\n\n  return body;\n}\n\nPageContainer.propTypes = {\n  Loading: PropTypes.func,\n  Error: PropTypes.func,\n  match: PropTypes.object,\n  client: PropTypes.object\n};\n","const config = {\n  // Parcel requires explicit env vars\n  apiKey: process.env.FIREBASE_API_KEY,\n  authDomain: process.env.FIREBASE_AUTH_DOMAIN,\n  databaseURL: process.env.FIREBASE_DATABASE_URL,\n  projectId: process.env.FIREBASE_PROJECT_ID,\n  storageBucket: process.env.FIREBASE_STORAGE_BUCKET,\n  messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,\n  appId: process.env.FIREBASE_APP_ID,\n  measurementId: process.env.FIREBASE_MEASUREMENT_ID\n};\n\nexport default config;\n","import gql from 'graphql-tag';\nimport {ApolloClient} from 'apollo-client';\nimport {setContext} from 'apollo-link-context';\nimport {createHttpLink} from 'apollo-link-http';\nimport {InMemoryCache} from 'apollo-cache-inmemory';\n\nexport default function getClient ({uri}) {\n  const http_link = createHttpLink({uri});\n\n  const auth_link = setContext(async (request, prev_context)=> {\n    const {headers = {}} = prev_context;\n    const token = await getToken();\n    if (token) {\n      headers.authorization = token ? `Bearer ${token}` : '';\n    }\n    return {headers};\n  });\n\n  const link = auth_link.concat(http_link);\n  const cache = new InMemoryCache();\n  const client = new ApolloClient({link, cache});\n\n  async function getToken () {\n    const query = gql`\n      {\n        token @client\n      }\n    `;\n    const {data} = await client.query({query});\n    return data.token;\n  }\n\n  function setToken (token) {\n    return client.writeData({data: {token}});\n  }\n\n  function clearToken () {\n    return setToken(null);\n  }\n\n  client.setToken = setToken;\n  client.clearToken = clearToken;\n\n  clearToken();\n  return client;\n}\n"],"names":["getGraphQLErrorCode","error","code","get","SessionContext","createContext","SessionProvider","$body","client","children","SessionUser","Loading","popup","useState","loaded","setLoaded","setError","user","_setUser","setUser","data","reload","useEffect","unsubscribe","Firebase","auth","onAuthStateChanged","firebase_user","body","finalizer","result","recover","getIdToken","token","setToken","load","clearToken","e","then","bind","h","Provider","value","start","email","password","provider_name","provider","provider_method","dedicated_providers","oauth_providers","action","includes","currentUser","sendEmailVerification","domain","toLowerCase","OAuthProvider","end","signOut","propTypes","PropTypes","func","object","bool","SessionConsumer","Consumer","useSession","useContext","PageContainer","Error","match","params","route","Page","page","loading","setLoading","setData","unmounted","query","page_query","runQuery","config","apiKey","process","env","FIREBASE_API_KEY","authDomain","FIREBASE_AUTH_DOMAIN","databaseURL","FIREBASE_DATABASE_URL","projectId","FIREBASE_PROJECT_ID","storageBucket","FIREBASE_STORAGE_BUCKET","messagingSenderId","FIREBASE_MESSAGING_SENDER_ID","appId","FIREBASE_APP_ID","measurementId","FIREBASE_MEASUREMENT_ID","http_link","createHttpLink","uri","link","setContext","request","prev_context","headers","gql","getToken","authorization","concat","cache","InMemoryCache","ApolloClient","writeData"],"mappings":"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"}