import"babel-polyfill";import{createContext as e,useState as n,useEffect as r,createElement as t,useContext as o}from"react";import a from"prop-types";import i from"firebase/app";import"firebase/auth";import s from"lodash.get";import c from"graphql-tag";import{ApolloClient as u}from"apollo-client";import{setContext as l}from"apollo-link-context";import{createHttpLink as p}from"apollo-link-http";import{InMemoryCache as d}from"apollo-cache-inmemory";function f(e){let n=s(e,"graphQLErrors[0].extensions.code",null);return n||(n=s(e,"networkError.result.errors[0].extensions.code",null)),n}const m=e();function E({client:e,children:o,SessionUser:a,Loading:s,popup:c=!0}){const[u,l]=n(!1),[p,d]=n(null),[E,h]=n(new a(null));function A(e){const n=new a(e);h(n)}function g(){}let w;return r(()=>{const n=i.auth().onAuthStateChanged(async n=>{try{if(n){const r=await n.getIdToken(!0);e.setToken(r),A(await a.load({client:e,token:r,firebase_user:n}))}else e.clearToken(),A(null)}catch(e){const n=f(e);d(n||"Session error")}finally{l(!0)}});return()=>{n()}},[]),w=u?o({user:E}):t(s,{user:E,error:p,reload:g}),t(m.Provider,{value:{loaded:u,error:p,user:E,start:async function({email:e,password:n,provider:r}){const t=i.auth(),o=c?"signInWithPopup":"signInWithRedirect";let a;if(r.includes("Email")){let o;"EmailSignin"===r?o="signInWithEmailAndPassword":"EmailSignup"===r&&(o="createUserWithEmailAndPassword"),a=await t[o](e,n),"createUserWithEmailAndPassword"===o&&(a=await t.currentUser.sendEmailVerification())}else if(["Google","Facebook","Twitter","Github"].includes(r)){const e=new(0,i.auth[r+"AuthProvider"]);a=await t[o](e)}else if(["Yahoo","Microsoft","Apple"].includes(r)){const e=r.toLowerCase()+".com",n=new i.auth.OAuthProvider(e);a=await t[o](n)}return a},reload:g,end:function(){return i.auth().signOut()}}},w)}E.propTypes={children:a.func,client:a.object,SessionUser:a.func,Loading:a.func,popup:a.bool};const{Consumer:h}=m;function A(){return o(m)}function g(){return A().user}let w,I=e=>e;function S({uri:e}){const n=p({uri:e}),r=l(async(e,n)=>{const{headers:r={}}=n,t=await async function(){const e=c(w||(w=I`
      {
        token @client
      }
    `)),{data:n}=await o.query({query:e});return n.token}();return t&&(r.authorization=t?"Bearer "+t:""),{headers:r}}).concat(n),t=new d,o=new u({link:r,cache:t});function a(e){return o.writeData({data:{token:e}})}function i(){return a(null)}return o.setToken=a,o.clearToken=i,i(),o}function y({Loading:e,Error:o,match:a,client:i}){const{params:s,route:c}=a,{page:u}=c,[l,p]=n(!0),[d,f]=n(null),[m,E]=n(null);let h;return r(()=>{let e=!1;return async function(){if(!e)if(u.query)try{const e=u.query(s),{data:n}=await i.query(e);E(n)}catch(e){f(e)}finally{p(!1)}else p(!1)}(),()=>{e=!0}},[]),h=l?t(e,null):d?t(o,{error:d}):t(u,Object.assign({params:s,route:c},m)),h}y.propTypes={Loading:a.func,Error:a.func,match:a.object,client:a.object};const _={apiKey:process.env.FIREBASE_API_KEY,authDomain:process.env.FIREBASE_AUTH_DOMAIN,databaseURL:process.env.FIREBASE_DATABASE_URL,projectId:process.env.FIREBASE_PROJECT_ID,storageBucket:process.env.FIREBASE_STORAGE_BUCKET,messagingSenderId:process.env.FIREBASE_MESSAGING_SENDER_ID,appId:process.env.FIREBASE_APP_ID,measurementId:process.env.FIREBASE_MEASUREMENT_ID};export{y as PageContainer,h as SessionConsumer,m as SessionContext,E as SessionProvider,_ as firebaseConfig,S as getClient,f as getGraphQLErrorCode,A as useSession,g as useSessionUser};
//# sourceMappingURL=index.modern.js.map
