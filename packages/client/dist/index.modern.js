import"babel-polyfill";import{createContext as e,useState as n,useEffect as r,useContext as t}from"react";import o from"prop-types";import a from"firebase/app";import"firebase/auth";import i from"lodash.get";import s from"graphql-tag";import{ApolloClient as c}from"apollo-client";import{setContext as u}from"apollo-link-context";import{createHttpLink as l}from"apollo-link-http";import{InMemoryCache as p}from"apollo-cache-inmemory";function d(e){let n=i(e,"graphQLErrors[0].extensions.code",null);return n||(n=i(e,"networkError.result.errors[0].extensions.code",null)),n}const f=e();function m({client:e,children:t,SessionUser:o,Loading:i,popup:s=!0}){const[c,u]=n(!1),[l,p]=n(null),[m,E]=n(new o(null));function A(e){const n=new o(e);E(n)}function g(){}let w;return r(()=>{const n=a.auth().onAuthStateChanged(async n=>{try{if(n){const r=await n.getIdToken(!0);e.setToken(r),A(await o.load({client:e,token:r,firebase_user:n}))}else e.clearToken(),A(null)}catch(e){const n=d(e);p(n||"Session error")}finally{u(!0)}});return()=>{n()}},[]),w=c?t({user:m}):h(i,{user:m,error:l,reload:g}),h(f.Provider,{value:{loaded:c,error:l,user:m,start:async function({email:e,password:n,provider:r}){const t=a.auth(),o=s?"signInWithPopup":"signInWithRedirect";let i;if(r.includes("Email")){let o;"EmailSignin"===r?o="signInWithEmailAndPassword":"EmailSignup"===r&&(o="createUserWithEmailAndPassword"),i=await t[o](e,n),"createUserWithEmailAndPassword"===o&&(i=await t.currentUser.sendEmailVerification())}else if(["Google","Facebook","Twitter","Github"].includes(r)){const e=new(0,a.auth[r+"AuthProvider"]);i=await t[o](e)}else if(["Yahoo","Microsoft","Apple"].includes(r)){const e=r.toLowerCase()+".com",n=new a.auth.OAuthProvider(e);i=await t[o](n)}return i},reload:g,end:function(){return a.auth().signOut()}}},w)}m.propTypes={children:o.func,client:o.object,SessionUser:o.func,Loading:o.func,popup:o.bool};const{Consumer:E}=f;function A(){return t(f)}function g(){return A().user}let w,I=e=>e;function S({uri:e}){const n=l({uri:e}),r=u(async(e,n)=>{const{headers:r={}}=n,t=await async function(){const e=s(w||(w=I`
      {
        token @client
      }
    `)),{data:n}=await o.query({query:e});return n.token}();return t&&(r.authorization=t?"Bearer "+t:""),{headers:r}}).concat(n),t=new p,o=new c({link:r,cache:t});function a(e){return o.writeData({data:{token:e}})}function i(){return a(null)}return o.setToken=a,o.clearToken=i,i(),o}function y({Loading:e,Error:t,match:o,client:a}){const{params:i,route:s}=o,{page:c}=s,[u,l]=n(!0),[p,d]=n(null),[f,m]=n(null);let E;return r(()=>{let e=!1;return async function(){if(!e)if(c.query)try{const e=c.query(i),{data:n}=await a.query(e);m(n)}catch(e){d(e)}finally{l(!1)}else l(!1)}(),()=>{e=!0}},[]),E=u?h(e,null):p?h(t,{error:p}):h(c,Object.assign({params:i,route:s},f)),E}y.propTypes={Loading:o.func,Error:o.func,match:o.object,client:o.object};const _={apiKey:process.env.FIREBASE_API_KEY,authDomain:process.env.FIREBASE_AUTH_DOMAIN,databaseURL:process.env.FIREBASE_DATABASE_URL,projectId:process.env.FIREBASE_PROJECT_ID,storageBucket:process.env.FIREBASE_STORAGE_BUCKET,messagingSenderId:process.env.FIREBASE_MESSAGING_SENDER_ID,appId:process.env.FIREBASE_APP_ID,measurementId:process.env.FIREBASE_MEASUREMENT_ID};export{y as PageContainer,E as SessionConsumer,f as SessionContext,m as SessionProvider,_ as firebaseConfig,S as getClient,d as getGraphQLErrorCode,A as useSession,g as useSessionUser};
//# sourceMappingURL=index.modern.js.map
